<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Poisson solvers · Oceananigans.jl</title><link rel="canonical" href="https://climate-machine.github.io/Oceananigans.jl/latest/manual/poisson_solvers/index.html"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Oceananigans.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../generated/simple_diffusion/">One-dimensional diffusion</a></li><li><a class="tocitem" href="../../generated/two_dimensional_turbulence/">Two-dimensional turbulence</a></li><li><a class="tocitem" href="../../generated/ocean_wind_mixing_and_convection/">Ocean wind mixing and convection</a></li><li><a class="tocitem" href="../../generated/ocean_convection_with_plankton/">Ocean convection with plankton</a></li><li><a class="tocitem" href="../../generated/internal_wave/">Internal wave</a></li></ul></li><li><a class="tocitem" href="../physics/">Physics</a></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox" checked/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">Numerical implementation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../pressure_decomposition/">Pressure decomposition</a></li><li><a class="tocitem" href="../time_stepping/">Time stepping</a></li><li><a class="tocitem" href="../finite_volume/">Finite volume method</a></li><li><a class="tocitem" href="../spatial_operators/">Spatial operators</a></li><li><a class="tocitem" href="../boundary_conditions/">Boundary conditions</a></li><li class="is-active"><a class="tocitem" href>Poisson solvers</a><ul class="internal"><li><a class="tocitem" href="#The-elliptic-problem-for-the-pressure-1"><span>The elliptic problem for the pressure</span></a></li><li><a class="tocitem" href="#Direct-method-1"><span>Direct method</span></a></li><li><a class="tocitem" href="#Direct-method-with-a-vertically-stretched-grid-1"><span>Direct method with a vertically stretched grid</span></a></li><li><a class="tocitem" href="#Cosine-transforms-on-the-GPU-1"><span>Cosine transforms on the GPU</span></a></li></ul></li><li><a class="tocitem" href="../large_eddy_simulation/">Large eddy simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Verification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../verification/taylor_green_vortex/">Taylor-Green vortex</a></li><li><a class="tocitem" href="../../verification/stratified_couette_flow/">Stratified Couette flow</a></li></ul></li></ul></li><li><a class="tocitem" href="../../gallery/">Gallery</a></li><li><a class="tocitem" href="../../benchmarks/">Benchmarks</a></li><li><a class="tocitem" href="../../library/">Library</a></li><li><a class="tocitem" href="../../subject_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li><a class="is-disabled">Numerical implementation</a></li><li class="is-active"><a href>Poisson solvers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Poisson solvers</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/climate-machine/Oceananigans.jl/blob/master/docs/src/manual/poisson_solvers.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Poisson-solvers-1">Poisson solvers<a class="docs-heading-anchor" href="#Poisson-solvers-1" title="Permalink"></a></h1><h2 id="The-elliptic-problem-for-the-pressure-1">The elliptic problem for the pressure<a class="docs-heading-anchor" href="#The-elliptic-problem-for-the-pressure-1" title="Permalink"></a></h2><p>The pressure field is obtained by taking the divergence of the horizontal component of the momentum equation \eqref{eq:momentumStar} and invoking the vertical component to yield an elliptic Poisson equation for the non-hydrostatic kinematic pressure</p><div>\[\nabla^2\phi_{NH} = \frac{\nabla \cdot \bm{u}^n}{\Delta t} + \nabla \cdot \bm{G}_{\bm{u}} \equiv \mathscr{F}\]</div><p>along with homogenous Neumann boundary conditions <span>$\bm{u} \cdot \bm{\hat{n}} = 0$</span> (Neumann on <span>$\phi$</span> for wall-bounded directions and periodic otherwise) and where <span>$\mathscr{F}$</span> denotes the source term for the Poisson equation.</p><h2 id="Direct-method-1">Direct method<a class="docs-heading-anchor" href="#Direct-method-1" title="Permalink"></a></h2><p>Discretizing elliptic problems that can be solved via a classical separation-of-variables approach, such as Poisson&#39;s equation, results in a linear system of equations <span>$M\bm{x} = \bm{y}$</span> where <span>$M$</span> is a real symmetric matrix of block tridiagonal form. This allows for the matrix to be decomposed and solved efficiently, provided that the eigenvalues and eigenvectors of the blocks are known \citep[\S2]{Buzbee70}. In the case of Poisson&#39;s equation on a rectangle, \citet{Hockney65} has taken advantage of the fact that the fast Fourier transform can be used to perform the matrix multiplication steps resulting in an even more efficient method. \citet{Schumann88} describe the implementation of such an algorithm for Poisson&#39;s equation on a staggered grid with Dirchlet, Neumann, and periodic boundary conditions.</p><p>The method can be explained easily by taking the Fourier transform of both sides of \eqref{eq:poisson-pressure} to yield</p><div>\[-(k_x^2 + k_y^2 + k_z^2) \widehat{\phi}_{NH} = \widehat{\mathscr{F}}
\quad \implies \quad
\widehat{\phi}_{NH} = - \frac{\widehat{\mathscr{F}}}{k_x^2 + k_y^2 + k_z^2}\]</div><p>where <span>$\widehat{\cdot}$</span> denotes the Fourier component. Here <span>$k_x$</span>, <span>$k_y$</span>, and <span>$k_z$</span> are the wavenumbers. However, when solving the equation on a staggered grid we require a solution for <span>$\phi_{NH}$</span> that is second-order accurate such that when when its Laplacian is computed, <span>$\nabla^2\phi_{NH}$</span> matches <span>$\mathscr{F}$</span> to machine precision. This is crucial to ensure that the projection step in \S\ref{sec:fractional-step} works. To do this, the wavenumbers are replaced by eigenvalues <span>$\lambda_x$</span>, <span>$\lambda_y$</span>, and <span>$\lambda_z$</span> satisfying the discrete form of Poisson&#39;s equation with appropriate boundary conditions. Thus, Poisson&#39;s equation&#39;s is diagonalized in Fourier space and the Fourier coefficients of the solution are easily solved for</p><div>\[\widehat{\phi}_{NH}(i, j, k) = - \frac{\widehat{\mathscr{F}}(i, j, k)}{\lambda^x_i + \lambda^y_j + \lambda^z_k}\]</div><p>The eigenvalues are given by \citet{Schumann88} and can also be tediously derived by plugging in the definition of the discrete Fourier transform into \eqref{eq:poisson-spectral}</p><div>\[\begin{aligned}
    \lambda^x_i &amp;= 4\frac{N_x^2}{L_x^2} \sin^2 \left [ \frac{(i-1)\pi}{N_x}  \right ], \quad i=0,1, \dots,N_x-1 \\
    \lambda^x_j &amp;= 4\frac{N_y^2}{L_y^2} \sin^2 \left [ \frac{(j-1)\pi}{N_y}  \right ], \quad j=0,1, \dots,N_y-1 \\
    \lambda^x_k &amp;= 4\frac{N_z^2}{L_z^2} \sin^2 \left [ \frac{(k-1)\pi}{2N_z} \right ], \quad k=0,1, \dots,N_z-1
\end{aligned}\]</div><p>where <span>$\lambda_x$</span> and <span>$\lambda_y$</span> correspond to periodic boundary conditions in the horizontal and <span>$\lambda_z$</span> to Neumann boundary conditions in the vertical.</p><p>There is also an ambiguity in the solution to Poisson&#39;s equation as it&#39;s only defined up to a constant. To resolve this we choose the solution with zero mean by setting the zeroth Fourier coefficient <span>$\phi_{000}$</span> (corresponding to <span>$k_x = k_y = k_z = 0$</span>) to zero. This also has the added benefit of discarding the zero eigenvalue so we don&#39;t divide by it.</p><p>The Fast Fourier transforms are computed using FFTW.jl \citep{Frigo98,Frigo05} on the CPU and using the cuFFT library on the GPU. Along wall-bouded dimensions, the cosine transform is used. In particular, as the transforms are performed on a staggered grid, DCT-II (<code>REDFT10</code>) is used to perform the forward cosine transform and DCT-III (<code>REDFT01</code>) is used to perform the inverse cosine transform.</p><h2 id="Direct-method-with-a-vertically-stretched-grid-1">Direct method with a vertically stretched grid<a class="docs-heading-anchor" href="#Direct-method-with-a-vertically-stretched-grid-1" title="Permalink"></a></h2><p>Using Fourier transforms for all three dimensions results in a method requiring <span>$\mathcal{O}(N \log_2 N)$</span> operations where <span>$N$</span> is the total number of grid points. This algorithm can be made even more efficient by solving a tridiagonal system along one of the dimensions and utilizing cyclic reduction. This results in the <em>Fourier analysis cyclic reduction</em> or <span>$\text{FACR}(\ell)$</span> algorithm (with <span>$\ell$</span> cyclic reduction steps) which requires only <span>$\mathcal{O}(N \log_2\log_2 N)$</span> operations provided the optimal number of cyclic reduction steps is taken, which is <span>$\ell = \log_2 \log_2 n$</span> where <span>$n$</span> is the number of grid points in the cyclic reduction dimension. The FACR algorithm was first developed by \citet{Hockney69} and is well reviewed by \citet{Swarztrauber77} then further benchmarked and extended by \citet{Temperton79} and \citet{Temperton80}.</p><p>Furthermore, the FACR algorithm removes the restriction that the grid is uniform in one of the dimensions so it can be utilized to implement a fast Poisson solver for vertically stretched grids if the cyclic reduction is applied in the along the vertical dimension.</p><p>Expanding <span>$\phi_{NH}$</span> and <span>$\mathscr{F}$</span> into Fourier modes along the <span>$x$</span> and <span>$y$</span> directions</p><div>\[\phi_{ijk} = \sum_{m=1}^{N_x} \sum_{n=1}^{N_y} \tilde{\phi}_{mnk} \; e^{-i2\pi im / N_x} \;  e^{-i2\pi jn / N_y}\]</div><p>and recalling that Fourier transforms do <span>$\partial_x \rightarrow ik_x$</span> and <span>$\partial_y \rightarrow ik_y$</span> we can write \eqref{eq:poisson-pressure} as</p><div>\[\sum_{m=1}^{N_x} \sum_{n=1}^{N_y}
\left\lbrace
    \partial_z^2 \tilde{\phi}_{mnk} - (k_x^2 + k_y^2) \tilde{\phi}_{mnk} - \tilde{\mathscr{F}}_{mnk}
\right\rbrace e^{-i2\pi im / N_x}  e^{-i2\pi jn / N_y} = 0\]</div><p>Discretizing the <span>$\partial_z^2$</span> derivative and equating the term inside the brackets to zero we arrive at <span>$N_x\times N_y$</span> symmetric tridiagonal systems of <span>$N_z$</span> linear equations for the Fourier modes:</p><div>\[\frac{\tilde{\phi}_{mn,k-1}}{\Delta z^F_{k-1}}
- \left\lbrace \frac{1}{1/\Delta z^F_{k-1} + 1/\Delta z^F_k} + \Delta z^C_k (k_x^2 + k_y^2) \right\rbrace
  \tilde{\phi}_{mnk}
+ \frac{\tilde{\phi}_{mn,k+1}}{\Delta z^F_k}
= \Delta z^C_k \tilde{\mathscr{F}}_{mnk}\]</div><h2 id="Cosine-transforms-on-the-GPU-1">Cosine transforms on the GPU<a class="docs-heading-anchor" href="#Cosine-transforms-on-the-GPU-1" title="Permalink"></a></h2><p>Unfortunately cuFFT does not provide cosine transforms and so we must write our own fast cosine transforms for the GPU. We implemented the fast 1D and 2D cosine transforms described by \citet{Makhoul80} which compute it by applying the regular Fourier transform to a permuted version of the array.</p><p>In this section we will be using the DCT-II as the definition of the forward cosine transform for a real signal of length <span>$N$</span></p><div>\[  \text{DCT}(X): \quad Y_k = 2 \sum_{j=0}^{N-1} \cos \left[ \frac{\pi(j + \frac{1}{2})k}{N} \right] X_j\]</div><p>and the DCT-III as the definition of the inverse cosine transform</p><div>\[  \text{IDCT}(X): \quad Y_k = X_0 + 2 \sum_{j=1}^{N-1} \cos \left[ \frac{\pi j (k + \frac{1}{2})}{N} \right] X_j\]</div><p>and will use <span>$\omega_M = e^{-2\pi i/M}$</span> to denote the <span>$M^\text{th}$</span> root of unity, sometimes called the twiddle factors in the context of FFT algorithms.</p><h3 id="D-fast-cosine-transform-1">1D fast cosine transform<a class="docs-heading-anchor" href="#D-fast-cosine-transform-1" title="Permalink"></a></h3><p>To calculate \eqref{eq:FCT} using the fast Fourier transform, we first permute the input signal along the appropriate dimension by ordering the odd elements first followed by the even elements to produce a permuted signal</p><div>\[    X^\prime_n =
    \begin{cases}
        \displaystyle X_{2N}, \quad 0 \le n \le \left[ \frac{N-1}{2} \right] \\
        \displaystyle X_{2N - 2n - 1}, \quad \left[ \frac{N+1}{2} \right] \le n \le N-1
    \end{cases}\]</div><p>where <span>$[a]$</span> indicates the integer part of <span>$a$</span>. This should produce, for example,</p><div>\[    (a, b, c, d, e, f, g, h) \quad \rightarrow \quad (a, c, e, g, h, f, d, b)\]</div><p>after which \eqref{eq:FCT} is computed using</p><div>\[  Y = \text{DCT}(X) = 2 \text{Re} \left\lbrace \omega_{4N}^k \text{FFT} \lbrace X^\prime \rbrace \right\rbrace\]</div><h3 id="D-fast-inverse-cosine-transform-1">1D fast inverse cosine transform<a class="docs-heading-anchor" href="#D-fast-inverse-cosine-transform-1" title="Permalink"></a></h3><p>The inverse \eqref{eq:IFCT} can be computed using</p><div>\[  Y = \text{IDCT}(X) = \text{Re} \left\lbrace \omega_{4N}^{-k} \text{IFFT} \lbrace X \rbrace \right\rbrace\]</div><p>after which the inverse permutation of \eqref{eq:permutation} must be applied.</p><h3 id="D-fast-cosine-transform-2">2D fast cosine transform<a class="docs-heading-anchor" href="#D-fast-cosine-transform-2" title="Permalink"></a></h3><p>Unfortunately, the 1D algorithm cannot be applied dimension-wise so the 2D algorithm is  more complicated. Thankfully though, the permutation \eqref{eq:permutation} can be applied dimension-wise. The forward cosine transform for a real signal of length <span>$N_1 \times N_2$</span> is then given by</p><div>\[Y_{k_1, k_2} = \text{DCT}(X_{n_1, n_2}) =
2 \text{Re} \left\lbrace
    \omega_{4N_1}^k \left( \omega_{4N_2}^k \tilde{X} + \omega_{4N_2}^{-k} \tilde{X}^- \right)
\right\rbrace\]</div><p>where <span>$\tilde{X} = \text{FFT}(X^\prime)$</span> and <span>$\tilde{X}^-$</span> indicates that <span>$\tilde{X}$</span> is indexed in reverse.</p><h3 id="D-fast-inverse-cosine-transform-2">2D fast inverse cosine transform<a class="docs-heading-anchor" href="#D-fast-inverse-cosine-transform-2" title="Permalink"></a></h3><p>The inverse can be computed using</p><div>\[Y_{k_1, k_2} = \text{IDCT}(X_{n_1, n_2}) =
\frac{1}{4} \text{Re} \left\lbrace
    \omega_{4N_1}^{-k} \omega_{4N_2}^{-k}
    \left( \tilde{X} - M_1 M_2 \tilde{X}^{--} \right)
    - i \left( M_1 \tilde{X}^{-+} + M_2 \tilde{X}^{+-} \right)
\right\rbrace\]</div><p>where <span>$\tilde{X} = \text{IFFT}(X)$</span> here, <span>$\tilde{X}^{-+}$</span> is indexed in reverse along the first dimension, <span>$\tilde{X}^{-+}$</span> along the second dimension, and <span>$\tilde{X}^{--}$</span> along both. <span>$M_1$</span> and <span>$M_2$</span> are masks of lengths <span>$N_1$</span> and <span>$N_2$</span> respectively, both containing ones except at the first element where <span>$M_0 = 0$</span>. Afterwards, the inverse permutation of \eqref{eq:permutation} must be applied.</p><p>Due to the extra steps involved in calculating the cosine transform in 2D, running with two wall-bounded dimensions typically slows the model down by a factor of 2. Switching to the FACR algorithm may help here as a 2D cosine transform won&#39;t be neccessary anymore.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../boundary_conditions/">« Boundary conditions</a><a class="docs-footer-nextpage" href="../large_eddy_simulation/">Large eddy simulation »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 4 November 2019 14:03">Monday 4 November 2019</span>. Using Julia version 1.2.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
