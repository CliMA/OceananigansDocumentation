<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Baroclinic adjustment ¬∑ Oceananigans.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://clima.github.io/OceananigansDocumentation/stable/generated/baroclinic_adjustment/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Oceananigans.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../quick_start/">Quick start</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../one_dimensional_diffusion/">One-dimensional diffusion</a></li><li><a class="tocitem" href="../two_dimensional_turbulence/">Two-dimensional turbulence</a></li><li><a class="tocitem" href="../internal_wave/">Internal wave</a></li><li><a class="tocitem" href="../convecting_plankton/">Convecting plankton</a></li><li><a class="tocitem" href="../ocean_wind_mixing_and_convection/">Ocean wind mixing and convection</a></li><li><a class="tocitem" href="../langmuir_turbulence/">Langmuir turbulence</a></li><li class="is-active"><a class="tocitem" href>Baroclinic adjustment</a><ul class="internal"><li><a class="tocitem" href="#Install-dependencies"><span>Install dependencies</span></a></li><li><a class="tocitem" href="#Grid"><span>Grid</span></a></li><li><a class="tocitem" href="#Turbulence-closures"><span>Turbulence closures</span></a></li><li><a class="tocitem" href="#Model"><span>Model</span></a></li><li><a class="tocitem" href="#Diagnostics/Output"><span>Diagnostics/Output</span></a></li><li><a class="tocitem" href="#Visualization"><span>Visualization</span></a></li></ul></li><li><a class="tocitem" href="../kelvin_helmholtz_instability/">Kelvin-Helmholtz instability</a></li><li><a class="tocitem" href="../shallow_water_Bickley_jet/">Shallow water Bickley jet</a></li><li><a class="tocitem" href="../horizontal_convection/">Horizontal convection</a></li><li><a class="tocitem" href="../tilted_bottom_boundary_layer/">Tilted bottom boundary layer</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/notation/">Coordinate system and notation</a></li><li><a class="tocitem" href="../../physics/boussinesq/">Boussinesq approximation</a></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label"><code>NonhydrostaticModel</code></span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/nonhydrostatic_model/">Nonhydrostatic model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label"><code>HydrostaticFreeSurfaceModel</code></span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/hydrostatic_free_surface_model/">Hydrostatic model with a free surface</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label"><code>ShallowWaterModel</code></span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/shallow_water_model/">Shallow water model</a></li></ul></li><li><a class="tocitem" href="../../physics/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../../physics/buoyancy_and_equations_of_state/">Buoyancy models and equations of state</a></li><li><a class="tocitem" href="../../physics/coriolis_forces/">Coriolis forces</a></li><li><a class="tocitem" href="../../physics/turbulence_closures/">Turbulence closures</a></li><li><a class="tocitem" href="../../physics/surface_gravity_waves/">Surface gravity waves and the Craik-Leibovich approximation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Numerical implementation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../numerical_implementation/finite_volume/">Finite volume method</a></li><li><a class="tocitem" href="../../numerical_implementation/spatial_operators/">Spatial operators</a></li><li><a class="tocitem" href="../../numerical_implementation/pressure_decomposition/">Pressure decomposition</a></li><li><a class="tocitem" href="../../numerical_implementation/time_stepping/">Time stepping</a></li><li><a class="tocitem" href="../../numerical_implementation/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../../numerical_implementation/elliptic_solvers/">Elliptic solvers</a></li><li><a class="tocitem" href="../../numerical_implementation/large_eddy_simulation/">Large eddy simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Model setup</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../model_setup/overview/">Overview</a></li><li><a class="tocitem" href="../../model_setup/architecture/">Architecture</a></li><li><a class="tocitem" href="../../model_setup/number_type/">Number type</a></li><li><a class="tocitem" href="../../model_setup/grids/">Grid</a></li><li><a class="tocitem" href="../../model_setup/clock/">Clock</a></li><li><a class="tocitem" href="../../model_setup/coriolis/">Coriolis (rotation)</a></li><li><a class="tocitem" href="../../model_setup/tracers/">Tracers</a></li><li><a class="tocitem" href="../../model_setup/buoyancy_and_equation_of_state/">Buoyancy models and equation of state</a></li><li><a class="tocitem" href="../../model_setup/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../../model_setup/forcing_functions/">Forcing functions</a></li><li><a class="tocitem" href="../../model_setup/background_fields/">Background fields</a></li><li><a class="tocitem" href="../../model_setup/turbulent_diffusivity_closures_and_les_models/">Turbulent diffusivity closures and LES models</a></li><li><a class="tocitem" href="../../model_setup/lagrangian_particles/">Lagrangian particles</a></li><li><a class="tocitem" href="../../model_setup/diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../model_setup/output_writers/">Output writers</a></li><li><a class="tocitem" href="../../model_setup/checkpointing/">Checkpointing</a></li><li><a class="tocitem" href="../../model_setup/setting_initial_conditions/">Setting initial conditions</a></li></ul></li><li><a class="tocitem" href="../../simulation_tips/">Simulation tips</a></li><li><a class="tocitem" href="../../contributing/">Contributor&#39;s guide</a></li><li><a class="tocitem" href="../../gallery/">Gallery</a></li><li><a class="tocitem" href="../../references/">References</a></li><li><input class="collapse-toggle" id="menuitem-11" type="checkbox"/><label class="tocitem" for="menuitem-11"><span class="docs-label">Appendix</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../appendix/staggered_grid/">Staggered grid</a></li><li><a class="tocitem" href="../../appendix/fractional_step/">Fractional step method</a></li><li><a class="tocitem" href="../../appendix/convergence_tests/">Convergence tests</a></li><li><a class="tocitem" href="../../appendix/benchmarks/">Performance benchmarks</a></li><li><a class="tocitem" href="../../appendix/library/">Library</a></li><li><a class="tocitem" href="../../appendix/function_index/">Function index</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Baroclinic adjustment</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Baroclinic adjustment</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Baroclinic-adjustment"><a class="docs-heading-anchor" href="#Baroclinic-adjustment">Baroclinic adjustment</a><a id="Baroclinic-adjustment-1"></a><a class="docs-heading-anchor-permalink" href="#Baroclinic-adjustment" title="Permalink"></a></h1><p>In this example, we simulate the evolution and equilibration of a baroclinically unstable front.</p><h2 id="Install-dependencies"><a class="docs-heading-anchor" href="#Install-dependencies">Install dependencies</a><a id="Install-dependencies-1"></a><a class="docs-heading-anchor-permalink" href="#Install-dependencies" title="Permalink"></a></h2><p>First let&#39;s make sure we have all required packages installed.</p><pre><code class="language-julia hljs">using Pkg
pkg&quot;add Oceananigans, CairoMakie&quot;</code></pre><pre><code class="language-julia hljs">using Oceananigans
using Oceananigans.Units</code></pre><h2 id="Grid"><a class="docs-heading-anchor" href="#Grid">Grid</a><a id="Grid-1"></a><a class="docs-heading-anchor-permalink" href="#Grid" title="Permalink"></a></h2><p>We use a three-dimensional channel that is periodic in the <code>x</code> direction:</p><pre><code class="language-julia hljs">Lx = 1000kilometers # east-west extent [m]
Ly = 1000kilometers # north-south extent [m]
Lz = 1kilometers    # depth [m]

Nx = 64
Ny = 64
Nz = 40

grid = RectilinearGrid(size = (Nx, Ny, Nz),
                       x = (0, Lx),
                       y = (-Ly/2, Ly/2),
                       z = (-Lz, 0),
                       topology = (Periodic, Bounded, Bounded))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">64√ó64√ó40 RectilinearGrid{Float64, Periodic, Bounded, Bounded} on CPU with 3√ó3√ó3 halo
‚îú‚îÄ‚îÄ Periodic x ‚àà [0.0, 1.0e6)          regularly spaced with Œîx=15625.0
‚îú‚îÄ‚îÄ Bounded  y ‚àà [-500000.0, 500000.0] regularly spaced with Œîy=15625.0
‚îî‚îÄ‚îÄ Bounded  z ‚àà [-1000.0, 0.0]        regularly spaced with Œîz=25.0</code></pre><h2 id="Turbulence-closures"><a class="docs-heading-anchor" href="#Turbulence-closures">Turbulence closures</a><a id="Turbulence-closures-1"></a><a class="docs-heading-anchor-permalink" href="#Turbulence-closures" title="Permalink"></a></h2><p>We prescribe the values of vertical viscocity and diffusivity according to the ratio of the vertical and lateral grid spacing.</p><pre><code class="language-julia hljs">Œîx, Œîz = Lx/Nx, Lz/Nz
ùíú = Œîz/Œîx # Grid cell aspect ratio.

Œ∫h = 0.1    # [m¬≤ s‚Åª¬π] horizontal diffusivity
ŒΩh = 0.1    # [m¬≤ s‚Åª¬π] horizontal viscosity
Œ∫z = ùíú * Œ∫h # [m¬≤ s‚Åª¬π] vertical diffusivity
ŒΩz = ùíú * ŒΩh # [m¬≤ s‚Åª¬π] vertical viscosity

horizontal_diffusive_closure = HorizontalScalarDiffusivity(ŒΩ = ŒΩh, Œ∫ = Œ∫h)

vertical_diffusive_closure = VerticalScalarDiffusivity(VerticallyImplicitTimeDiscretization();
                                                       ŒΩ = ŒΩz, Œ∫ = Œ∫z)</code></pre><h2 id="Model"><a class="docs-heading-anchor" href="#Model">Model</a><a id="Model-1"></a><a class="docs-heading-anchor-permalink" href="#Model" title="Permalink"></a></h2><p>We built a <code>HydrostaticFreeSurfaceModel</code> with an <code>ImplicitFreeSurface</code> solver. Regarding Coriolis, we use a beta-plane centered at 45¬∞ South.</p><pre><code class="language-julia hljs">model = HydrostaticFreeSurfaceModel(; grid,
                                    coriolis = BetaPlane(latitude = -45),
                                    buoyancy = BuoyancyTracer(),
                                    tracers = :b,
                                    closure = (vertical_diffusive_closure, horizontal_diffusive_closure),
                                    momentum_advection = WENO(),
                                    tracer_advection = WENO(),
                                    free_surface = ImplicitFreeSurface())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">HydrostaticFreeSurfaceModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)
‚îú‚îÄ‚îÄ grid: 64√ó64√ó40 RectilinearGrid{Float64, Periodic, Bounded, Bounded} on CPU with 3√ó3√ó3 halo
‚îú‚îÄ‚îÄ timestepper: QuasiAdamsBashforth2TimeStepper
‚îú‚îÄ‚îÄ tracers: b
‚îú‚îÄ‚îÄ closure: Tuple with 2 closures:
‚îÇ   ‚îú‚îÄ‚îÄ VerticalScalarDiffusivity{VerticallyImplicitTimeDiscretization}(ŒΩ=0.00016, Œ∫=(b=0.00016,))
‚îÇ   ‚îî‚îÄ‚îÄ HorizontalScalarDiffusivity{ExplicitTimeDiscretization}(ŒΩ=0.1, Œ∫=(b=0.1,))
‚îú‚îÄ‚îÄ buoyancy: BuoyancyTracer with -gÃÇ = ZDirection
‚îú‚îÄ‚îÄ free surface: ImplicitFreeSurface with gravitational acceleration 9.80665 m s‚Åª¬≤
‚îÇ   ‚îî‚îÄ‚îÄ solver: FFTImplicitFreeSurfaceSolver
‚îî‚îÄ‚îÄ coriolis: BetaPlane{Float64}</code></pre><p>We want to initialize our model with a baroclinically unstable front plus some small-amplitude noise.</p><pre><code class="language-julia hljs">&quot;&quot;&quot;
    ramp(y, Œîy)

Linear ramp from 0 to 1 between -Œîy/2 and +Œîy/2.

For example:
```
            y &lt; -Œîy/2 =&gt; ramp = 0
    -Œîy/2 &lt; y &lt; -Œîy/2 =&gt; ramp = y / Œîy
            y &gt;  Œîy/2 =&gt; ramp = 1
```
&quot;&quot;&quot;
ramp(y, Œîy) = min(max(0, y/Œîy + 1/2), 1)</code></pre><p>We then use <code>ramp(y, Œîy)</code> to construct an initial buoyancy configuration of a baroclinically unstable front. The front has a buoyancy jump <code>Œîb</code> over a latitudinal width <code>Œîy</code>.</p><pre><code class="language-julia hljs">N¬≤ = 4e-6 # [s‚Åª¬≤] buoyancy frequency / stratification
M¬≤ = 8e-8 # [s‚Åª¬≤] horizontal buoyancy gradient

Œîy = 50kilometers # width of the region of the front
Œîb = Œîy * M¬≤      # buoyancy jump associated with the front
œµb = 1e-2 * Œîb    # noise amplitude

b·µ¢(x, y, z) = N¬≤ * z + Œîb * ramp(y, Œîy) + œµb * randn()

set!(model, b=b·µ¢)</code></pre><p>Let&#39;s visualize the initial buoyancy distribution.</p><pre><code class="language-julia hljs">using CairoMakie

x, y, z = 1e-3 .* nodes((Center, Center, Center), grid) # convert m -&gt; km

b = model.tracers.b

fig, ax, hm = heatmap(y, z, interior(b)[1, :, :],
                      colormap=:deep,
                      axis = (xlabel = &quot;y [km]&quot;,
                              ylabel = &quot;z [km]&quot;,
                              title = &quot;b(x=0, y, z, t=0)&quot;,
                              titlesize = 24))

Colorbar(fig[1, 2], hm, label = &quot;[m s‚Åª¬≤]&quot;)</code></pre><p><img src="../initial_buoyancy.png" alt/></p><p>Now let&#39;s built a <code>Simulation</code>.</p><pre><code class="language-julia hljs">Œît‚ÇÄ = 5minutes
stop_time = 40days

simulation = Simulation(model, Œît=Œît‚ÇÄ, stop_time=stop_time)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Simulation of HydrostaticFreeSurfaceModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)
‚îú‚îÄ‚îÄ Next time step: 5 minutes
‚îú‚îÄ‚îÄ Elapsed wall time: 0 seconds
‚îú‚îÄ‚îÄ Wall time per iteration: NaN years
‚îú‚îÄ‚îÄ Stop time: 40 days
‚îú‚îÄ‚îÄ Stop iteration : Inf
‚îú‚îÄ‚îÄ Wall time limit: Inf
‚îú‚îÄ‚îÄ Callbacks: OrderedDict with 4 entries:
‚îÇ   ‚îú‚îÄ‚îÄ stop_time_exceeded =&gt; Callback of stop_time_exceeded on IterationInterval(1)
‚îÇ   ‚îú‚îÄ‚îÄ stop_iteration_exceeded =&gt; Callback of stop_iteration_exceeded on IterationInterval(1)
‚îÇ   ‚îú‚îÄ‚îÄ wall_time_limit_exceeded =&gt; Callback of wall_time_limit_exceeded on IterationInterval(1)
‚îÇ   ‚îî‚îÄ‚îÄ nan_checker =&gt; Callback of NaNChecker for u on IterationInterval(100)
‚îú‚îÄ‚îÄ Output writers: OrderedDict with no entries
‚îî‚îÄ‚îÄ Diagnostics: OrderedDict with no entries</code></pre><p>We add a <code>TimeStepWizard</code> callback to adapt the siulation&#39;s time-step,</p><pre><code class="language-julia hljs">wizard = TimeStepWizard(cfl=0.2, max_change=1.1, max_Œît=20minutes)

simulation.callbacks[:wizard] = Callback(wizard, IterationInterval(20))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Callback of TimeStepWizard(cfl=0.2, max_Œît=1200.0, min_Œît=0.0) on IterationInterval(20)</code></pre><p>Also, we add a callback to print a message about how the simulation is going,</p><pre><code class="language-julia hljs">using Printf

wall_clock = [time_ns()]

function print_progress(sim)
    @printf(&quot;[%05.2f%%] i: %d, t: %s, wall time: %s, max(u): (%6.3e, %6.3e, %6.3e) m/s, next Œît: %s\n&quot;,
            100 * (sim.model.clock.time / sim.stop_time),
            sim.model.clock.iteration,
            prettytime(sim.model.clock.time),
            prettytime(1e-9 * (time_ns() - wall_clock[1])),
            maximum(abs, sim.model.velocities.u),
            maximum(abs, sim.model.velocities.v),
            maximum(abs, sim.model.velocities.w),
            prettytime(sim.Œît))

    wall_clock[1] = time_ns()

    return nothing
end

simulation.callbacks[:print_progress] = Callback(print_progress, IterationInterval(100))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Callback of print_progress on IterationInterval(100)</code></pre><h2 id="Diagnostics/Output"><a class="docs-heading-anchor" href="#Diagnostics/Output">Diagnostics/Output</a><a id="Diagnostics/Output-1"></a><a class="docs-heading-anchor-permalink" href="#Diagnostics/Output" title="Permalink"></a></h2><p>Add some diagnostics. Here, we save the buoyancy, <span>$b$</span>, at the edges of our domain as well as the zonal (<span>$x$</span>) averages of buoyancy and zonal velocity <span>$u$</span>.</p><pre><code class="language-julia hljs">u, v, w = model.velocities

B = Field(Average(b, dims=1))
U = Field(Average(u, dims=1))

filename = &quot;baroclinic_adjustment&quot;
save_fields_interval = 0.5day

slicers = (west = (1, :, :),
           east = (grid.Nx, :, :),
           south = (:, 1, :),
           north = (:, grid.Ny, :),
           bottom = (:, :, 1),
           top = (:, :, grid.Nz))

for side in keys(slicers)
    indices = slicers[side]

    simulation.output_writers[side] = JLD2OutputWriter(model, (; b);
                                                       filename = filename * &quot;_$(side)_slice&quot;,
                                                       schedule = TimeInterval(save_fields_interval),
                                                       indices)
end

simulation.output_writers[:zonal] = JLD2OutputWriter(model, (b=B,);
                                                     schedule = TimeInterval(save_fields_interval),
                                                     filename = filename * &quot;_zonal_average&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">JLD2OutputWriter scheduled on TimeInterval(12 hours):
‚îú‚îÄ‚îÄ filepath: ./baroclinic_adjustment_zonal_average.jld2
‚îú‚îÄ‚îÄ 1 outputs: b
‚îú‚îÄ‚îÄ array type: Array{Float32}
‚îú‚îÄ‚îÄ including: [:grid, :coriolis, :buoyancy, :closure]
‚îî‚îÄ‚îÄ max filesize: Inf YiB</code></pre><p>Now let&#39;s run!</p><pre><code class="language-julia hljs">@info &quot;Running the simulation...&quot;

run!(simulation)

@info &quot;Simulation completed in &quot; * prettytime(simulation.run_wall_time)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Running the simulation...
[ Info: Initializing simulation...
[00.00%] i: 0, t: 0 seconds, wall time: 30.055 seconds, max(u): (0.000e+00, 0.000e+00, 0.000e+00) m/s, next Œît: 5.500 minutes
[ Info:     ... simulation initialization complete (14.555 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (2.166 minutes).
[01.17%] i: 100, t: 11.193 hours, wall time: 2.617 minutes, max(u): (6.988e-01, 3.326e-01, 3.363e-03) m/s, next Œît: 8.858 minutes
[03.03%] i: 200, t: 1.213 days, wall time: 18.331 seconds, max(u): (6.061e-01, 3.520e-01, 2.524e-03) m/s, next Œît: 14.266 minutes
[05.99%] i: 300, t: 2.396 days, wall time: 16.667 seconds, max(u): (5.584e-01, 2.879e-01, 2.026e-03) m/s, next Œît: 20 minutes
[09.44%] i: 400, t: 3.778 days, wall time: 16.629 seconds, max(u): (4.729e-01, 2.783e-01, 1.811e-03) m/s, next Œît: 20 minutes
[12.92%] i: 500, t: 5.167 days, wall time: 14.779 seconds, max(u): (4.612e-01, 2.459e-01, 1.641e-03) m/s, next Œît: 20 minutes
[16.39%] i: 600, t: 6.556 days, wall time: 14.745 seconds, max(u): (4.581e-01, 2.598e-01, 1.913e-03) m/s, next Œît: 20 minutes
[19.86%] i: 700, t: 7.944 days, wall time: 14.803 seconds, max(u): (4.867e-01, 4.474e-01, 2.172e-03) m/s, next Œît: 20 minutes
[23.14%] i: 800, t: 9.257 days, wall time: 14.900 seconds, max(u): (5.575e-01, 6.053e-01, 2.478e-03) m/s, next Œît: 18.286 minutes
[26.05%] i: 900, t: 10.419 days, wall time: 14.649 seconds, max(u): (7.626e-01, 7.252e-01, 5.117e-03) m/s, next Œît: 15.446 minutes
[28.84%] i: 1000, t: 11.537 days, wall time: 14.726 seconds, max(u): (7.789e-01, 7.582e-01, 4.354e-03) m/s, next Œît: 19.141 minutes
[31.71%] i: 1100, t: 12.684 days, wall time: 14.630 seconds, max(u): (8.256e-01, 8.570e-01, 4.517e-03) m/s, next Œît: 15.376 minutes
[34.53%] i: 1200, t: 13.811 days, wall time: 14.796 seconds, max(u): (7.795e-01, 8.646e-01, 4.680e-03) m/s, next Œît: 17.807 minutes
[37.53%] i: 1300, t: 15.012 days, wall time: 14.468 seconds, max(u): (8.063e-01, 8.427e-01, 4.690e-03) m/s, next Œît: 17.768 minutes
[40.86%] i: 1400, t: 16.345 days, wall time: 14.861 seconds, max(u): (8.867e-01, 8.449e-01, 4.127e-03) m/s, next Œît: 20 minutes
[44.31%] i: 1500, t: 17.722 days, wall time: 15.507 seconds, max(u): (8.768e-01, 8.053e-01, 3.708e-03) m/s, next Œît: 20 minutes
[47.78%] i: 1600, t: 19.111 days, wall time: 15.103 seconds, max(u): (7.566e-01, 9.701e-01, 3.179e-03) m/s, next Œît: 20 minutes
[51.25%] i: 1700, t: 20.500 days, wall time: 14.714 seconds, max(u): (8.296e-01, 9.522e-01, 2.683e-03) m/s, next Œît: 20 minutes
[54.72%] i: 1800, t: 21.889 days, wall time: 14.746 seconds, max(u): (8.599e-01, 9.753e-01, 2.753e-03) m/s, next Œît: 20 minutes
[58.19%] i: 1900, t: 23.278 days, wall time: 14.710 seconds, max(u): (9.487e-01, 8.012e-01, 2.621e-03) m/s, next Œît: 20 minutes
[61.67%] i: 2000, t: 24.667 days, wall time: 14.513 seconds, max(u): (9.170e-01, 7.861e-01, 2.705e-03) m/s, next Œît: 20 minutes
[65.14%] i: 2100, t: 26.056 days, wall time: 14.508 seconds, max(u): (9.553e-01, 8.331e-01, 2.521e-03) m/s, next Œît: 20 minutes
[68.61%] i: 2200, t: 27.444 days, wall time: 14.091 seconds, max(u): (8.980e-01, 8.257e-01, 2.346e-03) m/s, next Œît: 20 minutes
[72.08%] i: 2300, t: 28.833 days, wall time: 15.478 seconds, max(u): (8.570e-01, 7.846e-01, 2.270e-03) m/s, next Œît: 20 minutes
[75.56%] i: 2400, t: 30.222 days, wall time: 14.534 seconds, max(u): (8.801e-01, 8.854e-01, 2.685e-03) m/s, next Œît: 20 minutes
[79.03%] i: 2500, t: 31.611 days, wall time: 14.133 seconds, max(u): (8.467e-01, 8.814e-01, 2.843e-03) m/s, next Œît: 20 minutes
[82.50%] i: 2600, t: 33 days, wall time: 14.664 seconds, max(u): (9.581e-01, 9.291e-01, 3.393e-03) m/s, next Œît: 20 minutes
[85.97%] i: 2700, t: 34.389 days, wall time: 14.092 seconds, max(u): (9.091e-01, 8.803e-01, 2.717e-03) m/s, next Œît: 20 minutes
[89.44%] i: 2800, t: 35.778 days, wall time: 14.437 seconds, max(u): (8.803e-01, 8.275e-01, 2.423e-03) m/s, next Œît: 20 minutes
[92.92%] i: 2900, t: 37.167 days, wall time: 14.371 seconds, max(u): (8.637e-01, 8.134e-01, 2.062e-03) m/s, next Œît: 20 minutes
[96.39%] i: 3000, t: 38.556 days, wall time: 14.656 seconds, max(u): (8.912e-01, 9.689e-01, 1.788e-03) m/s, next Œît: 20 minutes
[99.86%] i: 3100, t: 39.944 days, wall time: 14.314 seconds, max(u): (7.771e-01, 1.008e+00, 1.803e-03) m/s, next Œît: 20 minutes
[ Info: Simulation is stopping. Model time 40 days has hit or exceeded simulation stop time 40 days.
[ Info: Simulation completed in 10.176 minutes</code></pre><h2 id="Visualization"><a class="docs-heading-anchor" href="#Visualization">Visualization</a><a id="Visualization-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization" title="Permalink"></a></h2><p>Now we are ready to visualize our resutls! We use <code>CairoMakie</code> in this example. On a system with OpenGL <code>using GLMakie</code> is more convenient as figures will be displayed on the screen.</p><pre><code class="language-julia hljs">using CairoMakie</code></pre><p>We load the saved buoyancy output on the top, bottom, and east surface as <code>FieldTimeSeries</code>es.</p><pre><code class="language-julia hljs">filename = &quot;baroclinic_adjustment&quot;

sides = keys(slicers)

slice_filenames = NamedTuple(side =&gt; filename * &quot;_$(side)_slice.jld2&quot; for side in sides)

b_timeserieses = (east   = FieldTimeSeries(slice_filenames.east, &quot;b&quot;),
                  north  = FieldTimeSeries(slice_filenames.north, &quot;b&quot;),
                  bottom = FieldTimeSeries(slice_filenames.bottom, &quot;b&quot;),
                  top    = FieldTimeSeries(slice_filenames.top, &quot;b&quot;))

avg_b_timeseries = FieldTimeSeries(filename * &quot;_zonal_average.jld2&quot;, &quot;b&quot;)</code></pre><p>We build the coordinates. We rescale horizontal coordinates so that they correspond to kilometers.</p><pre><code class="language-julia hljs">x, y, z = nodes(b_timeserieses.east)

x = x .* 1e-3 # convert m -&gt; km
y = y .* 1e-3 # convert m -&gt; km

x_xz = repeat(x, 1, Nz)
y_xz_north = y[end] * ones(Nx, Nz)
z_xz = repeat(reshape(z, 1, Nz), Nx, 1)

x_yz_east = x[end] * ones(Ny, Nz)
y_yz = repeat(y, 1, Nz)
z_yz = repeat(reshape(z, 1, Nz), grid.Ny, 1)

x_xy = x
y_xy = y
z_xy_top = z[end] * ones(grid.Nx, grid.Ny)
z_xy_bottom = z[1] * ones(grid.Nx, grid.Ny)</code></pre><p>Then we create a 3D axis. We use <code>zonal_slice_displacement</code> to control where the plot of the instantaneous zonal average flow is located.</p><pre><code class="language-julia hljs">fig = Figure(resolution = (900, 520))

zonal_slice_displacement = 1.2

ax = Axis3(fig[2, 1], aspect=(1, 1, 1/5),
           xlabel=&quot;x (km)&quot;, ylabel=&quot;y (km)&quot;, zlabel=&quot;z (m)&quot;,
           limits = ((x[1], zonal_slice_displacement * x[end]), (y[1], y[end]), (z[1], z[end])),
           elevation = 0.45, azimuth = 6.8,
           xspinesvisible = false, zgridvisible=false,
           protrusions=40,
           perspectiveness=0.7)</code></pre><p>We use Makie&#39;s <code>Observable</code> to animate the data. To dive into how <code>Observable</code>s work we refer to <a href="https://makie.juliaplots.org/stable/documentation/nodes/index.html">Makie.jl&#39;s Documentation</a>.</p><pre><code class="language-julia hljs">n = Observable(1)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Observable{Int64} with 0 listeners. Value:
1</code></pre><p>Now let&#39;s make a 3D plot of the buoyancy and in front of it we&#39;ll use the zonally-averaged output to plot the instantaneous zonal-average of the buoyancy.</p><pre><code class="language-julia hljs">b_slices = (east   = @lift(interior(b_timeserieses.east[$n], 1, :, :)),
            north  = @lift(interior(b_timeserieses.north[$n], :, 1, :)),
            bottom = @lift(interior(b_timeserieses.bottom[$n], :, :, 1)),
            top    = @lift(interior(b_timeserieses.top[$n], :, :, 1)))

avg_b = @lift interior(avg_b_timeseries[$n], 1, :, :)

clims = @lift 1.1 .* extrema(b_timeserieses.top[$n][:])

kwargs = (colorrange = clims, colormap = :deep)

surface!(ax, x_yz_east, y_yz, z_yz;    color = b_slices.east, kwargs...)
surface!(ax, x_xz, y_xz_north, z_xz;   color = b_slices.north, kwargs...)
surface!(ax, x_xy, y_xy, z_xy_bottom ; color = b_slices.bottom, kwargs...)
surface!(ax, x_xy, y_xy, z_xy_top;     color = b_slices.top, kwargs...)

sf = surface!(ax, zonal_slice_displacement .* x_yz_east, y_yz, z_yz; color = avg_b, kwargs...)

contour!(ax, y, z, avg_b; transformation = (:yz, zonal_slice_displacement * x[end]),
         levels = 15, linewidth = 2, color = :black)

Colorbar(fig[2, 2], sf, label = &quot;m s‚Åª¬≤&quot;, height = 200, tellheight=false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Colorbar()</code></pre><p>Finally, we add a figure title with the time of the snapshot and then record a movie.</p><pre><code class="language-julia hljs">times = avg_b_timeseries.times

title = @lift &quot;Buoyancy at t = &quot; * string(round(times[$n] / day, digits=1)) * &quot; days&quot;

fig[1, 1:2] = Label(fig, title; textsize = 24, tellwidth = false, padding = (0, 0, -120, 0))

frames = 1:length(times)

record(fig, filename * &quot;.mp4&quot;, frames, framerate=8) do i
    msg = string(&quot;Plotting frame &quot;, i, &quot; of &quot;, frames[end])
    print(msg * &quot; \r&quot;)
    n[] = i
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Plotting frame 1 of 81 Plotting frame 2 of 81 Plotting frame 3 of 81 Plotting frame 4 of 81 Plotting frame 5 of 81 Plotting frame 6 of 81 Plotting frame 7 of 81 Plotting frame 8 of 81 Plotting frame 9 of 81 Plotting frame 10 of 81 Plotting frame 11 of 81 Plotting frame 12 of 81 Plotting frame 13 of 81 Plotting frame 14 of 81 Plotting frame 15 of 81 Plotting frame 16 of 81 Plotting frame 17 of 81 Plotting frame 18 of 81 Plotting frame 19 of 81 Plotting frame 20 of 81 Plotting frame 21 of 81 Plotting frame 22 of 81 Plotting frame 23 of 81 Plotting frame 24 of 81 Plotting frame 25 of 81 Plotting frame 26 of 81 Plotting frame 27 of 81 Plotting frame 28 of 81 Plotting frame 29 of 81 Plotting frame 30 of 81 Plotting frame 31 of 81 Plotting frame 32 of 81 Plotting frame 33 of 81 Plotting frame 34 of 81 Plotting frame 35 of 81 Plotting frame 36 of 81 Plotting frame 37 of 81 Plotting frame 38 of 81 Plotting frame 39 of 81 Plotting frame 40 of 81 Plotting frame 41 of 81 Plotting frame 42 of 81 Plotting frame 43 of 81 Plotting frame 44 of 81 Plotting frame 45 of 81 Plotting frame 46 of 81 Plotting frame 47 of 81 Plotting frame 48 of 81 Plotting frame 49 of 81 Plotting frame 50 of 81 Plotting frame 51 of 81 Plotting frame 52 of 81 Plotting frame 53 of 81 Plotting frame 54 of 81 Plotting frame 55 of 81 Plotting frame 56 of 81 Plotting frame 57 of 81 Plotting frame 58 of 81 Plotting frame 59 of 81 Plotting frame 60 of 81 Plotting frame 61 of 81 Plotting frame 62 of 81 Plotting frame 63 of 81 Plotting frame 64 of 81 Plotting frame 65 of 81 Plotting frame 66 of 81 Plotting frame 67 of 81 Plotting frame 68 of 81 Plotting frame 69 of 81 Plotting frame 70 of 81 Plotting frame 71 of 81 Plotting frame 72 of 81 Plotting frame 73 of 81 Plotting frame 74 of 81 Plotting frame 75 of 81 Plotting frame 76 of 81 Plotting frame 77 of 81 Plotting frame 78 of 81 Plotting frame 79 of 81 Plotting frame 80 of 81 Plotting frame 81 of 81</code></pre><p><video src="../baroclinic_adjustment.mp4" controls="true" title><a href="../baroclinic_adjustment.mp4"></a></video></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../langmuir_turbulence/">¬´ Langmuir turbulence</a><a class="docs-footer-nextpage" href="../kelvin_helmholtz_instability/">Kelvin-Helmholtz instability ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Wednesday 28 September 2022 12:40">Wednesday 28 September 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
