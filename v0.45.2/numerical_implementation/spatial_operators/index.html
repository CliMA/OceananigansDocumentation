<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Spatial operators · Oceananigans.jl</title><link rel="canonical" href="https://clima.github.io/OceananigansDocumentation/stable/numerical_implementation/spatial_operators/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Oceananigans.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../using_gpus/">Using GPUs</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../generated/one_dimensional_diffusion/">One-dimensional diffusion</a></li><li><a class="tocitem" href="../../generated/two_dimensional_turbulence/">Two-dimensional turbulence</a></li><li><a class="tocitem" href="../../generated/internal_wave/">Internal wave</a></li><li><a class="tocitem" href="../../generated/convecting_plankton/">Convecting plankton</a></li><li><a class="tocitem" href="../../generated/ocean_wind_mixing_and_convection/">Ocean wind mixing and convection</a></li><li><a class="tocitem" href="../../generated/langmuir_turbulence/">Langmuir turbulence</a></li><li><a class="tocitem" href="../../generated/eady_turbulence/">Eady turbulence</a></li><li><a class="tocitem" href="../../generated/kelvin_helmholtz_instability/">Kelvin-Helmholtz instability</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Model setup</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../model_setup/overview/">Overview</a></li><li><a class="tocitem" href="../../model_setup/architecture/">Architecture</a></li><li><a class="tocitem" href="../../model_setup/number_type/">Number type</a></li><li><a class="tocitem" href="../../model_setup/grids/">Grid</a></li><li><a class="tocitem" href="../../model_setup/clock/">Clock</a></li><li><a class="tocitem" href="../../model_setup/coriolis/">Coriolis (rotation)</a></li><li><a class="tocitem" href="../../model_setup/tracers/">Tracers</a></li><li><a class="tocitem" href="../../model_setup/buoyancy_and_equation_of_state/">Buoyancy and equation of state</a></li><li><a class="tocitem" href="../../model_setup/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../../model_setup/forcing_functions/">Forcing functions</a></li><li><a class="tocitem" href="../../model_setup/background_fields/">Background fields</a></li><li><a class="tocitem" href="../../model_setup/turbulent_diffusivity_closures_and_les_models/">Turbulent diffusivity closures and LES models</a></li><li><a class="tocitem" href="../../model_setup/diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../model_setup/output_writers/">Output writers</a></li><li><a class="tocitem" href="../../model_setup/checkpointing/">Checkpointing</a></li><li><a class="tocitem" href="../../model_setup/time_stepping/">Time stepping</a></li><li><a class="tocitem" href="../../model_setup/setting_initial_conditions/">Setting initial conditions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/navier_stokes_and_tracer_conservation/">Navier-Stokes and tracer conservation equations</a></li><li><a class="tocitem" href="../../physics/coriolis_forces/">Coriolis forces</a></li><li><a class="tocitem" href="../../physics/buoyancy_and_equations_of_state/">Buoyancy model and equations of state</a></li><li><a class="tocitem" href="../../physics/turbulence_closures/">Turbulence closures</a></li><li><a class="tocitem" href="../../physics/surface_gravity_waves/">Surface gravity waves and the Craik-Leibovich approximation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Numerical implementation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../pressure_decomposition/">Pressure decomposition</a></li><li><a class="tocitem" href="../time_stepping/">Time stepping</a></li><li><a class="tocitem" href="../finite_volume/">Finite volume method</a></li><li class="is-active"><a class="tocitem" href>Spatial operators</a><ul class="internal"><li><a class="tocitem" href="#Differences"><span>Differences</span></a></li><li><a class="tocitem" href="#Interpolation"><span>Interpolation</span></a></li><li><a class="tocitem" href="#Divergence-and-flux-divergence"><span>Divergence and flux divergence</span></a></li><li><a class="tocitem" href="#Momentum-advection"><span>Momentum advection</span></a></li><li><a class="tocitem" href="#Discretization-of-isotropic-diffusion-operators"><span>Discretization of isotropic diffusion operators</span></a></li><li><a class="tocitem" href="#Vertical-integrals"><span>Vertical integrals</span></a></li></ul></li><li><a class="tocitem" href="../boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../poisson_solvers/">Poisson solvers</a></li><li><a class="tocitem" href="../large_eddy_simulation/">Large eddy simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Validation experiments</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../validation/convergence_tests/">Convergence tests</a></li><li><a class="tocitem" href="../../validation/lid_driven_cavity/">Lid-driven cavity</a></li><li><a class="tocitem" href="../../validation/stratified_couette_flow/">Stratified Couette flow</a></li></ul></li><li><a class="tocitem" href="../../gallery/">Gallery</a></li><li><a class="tocitem" href="../../benchmarks/">Performance benchmarks</a></li><li><a class="tocitem" href="../../contributing/">Contributor&#39;s guide</a></li><li><input class="collapse-toggle" id="menuitem-12" type="checkbox"/><label class="tocitem" for="menuitem-12"><span class="docs-label">Appendix</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../appendix/staggered_grid/">Staggered grid</a></li><li><a class="tocitem" href="../../appendix/fractional_step/">Fractional step method</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li><li><a class="tocitem" href="../../library/">Library</a></li><li><a class="tocitem" href="../../function_index/">Function index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Numerical implementation</a></li><li class="is-active"><a href>Spatial operators</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Spatial operators</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/Oceananigans.jl/blob/master/docs/src/numerical_implementation/spatial_operators.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Spatial-operators"><a class="docs-heading-anchor" href="#Spatial-operators">Spatial operators</a><a id="Spatial-operators-1"></a><a class="docs-heading-anchor-permalink" href="#Spatial-operators" title="Permalink"></a></h1><p>To calculate the various terms and perform the time-stepping, discrete difference and interpolation operators must be designed from which all the terms, such as momentum advection and Laplacian diffusion, may be constructed. Much of the material in this section is derived from <a href="../../references/#Marshall97FV">John Marshall , Alistair Adcroft , Chris Hill , Lev Perelman , Curt Heisey  (1997)</a>.</p><h2 id="Differences"><a class="docs-heading-anchor" href="#Differences">Differences</a><a id="Differences-1"></a><a class="docs-heading-anchor-permalink" href="#Differences" title="Permalink"></a></h2><p>Difference operators act as the discrete form of the derivative operator. Care must be taken when calculating differences on a staggered grid. For example, the the difference of a cell-centered variable such as temperature <span>$T$</span> lies on the faces  in the direction of the difference, and vice versa. In principle, there are three difference operators, one for each  direction</p><p class="math-container">\[  \delta_x f = f_E - f_W, \quad
  \delta_y f = f_N - f_S , \quad
  \delta_z f = f_T - f_B ,\]</p><p>where the <span>$E$</span> and <span>$W$</span> subscripts indicate that the value is evaluated the eastern or western wall of the cell, <span>$N$</span> and <span>$S$</span> indicate the northern and southern walls, and <span>$T$</span> and <span>$B$</span> indicate the top and bottom walls.</p><p>Additionally, two <span>$\delta$</span> operators must be defined for each direction to account for the staggered nature of the grid. One for taking the difference of a cell-centered variable and projecting it onto the cell faces</p><p class="math-container">\[\begin{aligned}
    \delta_x^{faa} f_{i,j,k} &amp;= f_{i,j,k} - f_{i-1,j,k} \\
    \delta_y^{afa} f_{i,j,k} &amp;= f_{i,j,k} - f_{i,j-1,k} \\
    \delta_z^{aaf} f_{i,j,k} &amp;= f_{i,j,k} - f_{i,j,k-1}
\end{aligned}\]</p><p>and another for taking the difference of a face-centered variable and projecting it onto the cell centers</p><p class="math-container">\[\begin{aligned}
    \delta_x^{caa} f_{i,j,k} &amp;= f_{i+1,j,k} - f_{i,j,k} \\
    \delta_y^{aca} f_{i,j,k} &amp;= f_{i,j+1,k} - f_{i,j,k} \\
    \delta_z^{aac} f_{i,j,k} &amp;= f_{i,j,k+1} - f_{i,j,k}
\end{aligned}\]</p><h2 id="Interpolation"><a class="docs-heading-anchor" href="#Interpolation">Interpolation</a><a id="Interpolation-1"></a><a class="docs-heading-anchor-permalink" href="#Interpolation" title="Permalink"></a></h2><p>In order to add or multiply variables that are defined at different points they are interpolated. In our case, linear interpolation or averaging is employed. Once again, there are two averaging operators, one for each direction, \begin{equation}   \overline{f}^x = \frac{f<em>E + f</em>W}{2} , \quad   \overline{f}^y = \frac{f<em>N + f</em>S}{2} , \quad   \overline{f}^z = \frac{f<em>T + f</em>B}{2} \end{equation}</p><p>Additionally, three averaging operators must be defined for each direction. One for taking the average of a cell-centered  variable and projecting it onto the cell faces</p><p class="math-container">\[\begin{aligned}
    \overline{f_{i,j,k}}^{faa} = \frac{f_{i,j,k} + f_{i-1,j,k}}{2} \\
    \overline{f_{i,j,k}}^{afa} = \frac{f_{i,j,k} + f_{i,j-1,k}}{2} \\
    \overline{f_{i,j,k}}^{aaf} = \frac{f_{i,j,k} + f_{i,j,k-1}}{2}
\end{aligned}\]</p><p>and another for taking the average of a face-centered variable and projecting it onto the cell centers</p><p class="math-container">\[\begin{aligned}
    \overline{f_{i,j,k}}^{caa} = \frac{f_{i+1,j,k} + f_{i,j,k}}{2} \\
    \overline{f_{i,j,k}}^{aca} = \frac{f_{i,j+1,k} + f_{i,j,k}}{2} \\
    \overline{f_{i,j,k}}^{aac} = \frac{f_{i,j,k+1} + f_{i,j,k}}{2}
\end{aligned}\]</p><h2 id="Divergence-and-flux-divergence"><a class="docs-heading-anchor" href="#Divergence-and-flux-divergence">Divergence and flux divergence</a><a id="Divergence-and-flux-divergence-1"></a><a class="docs-heading-anchor-permalink" href="#Divergence-and-flux-divergence" title="Permalink"></a></h2><p>The divergence of the flux of a cell-centered quantity over the cell can be calculated as</p><p class="math-container">\[\nabla \cdot \bm{f}
= \frac{1}{V} \left[ \delta_x^{faa} (A_x f_x)
                   + \delta_y^{afa} (A_y f_y)
                   + \delta_z^{aaf} (A_z f_z) \right]\]</p><p>where <span>$\bm{f} = (f_x, f_y, f_z)$</span> is the flux with components defined normal to the faces, and <span>$V$</span> is the volume of the cell. The presence of a solid boundary is indicated by setting the appropriate flux normal to the boundary to zero.</p><p>A similar divergence operator can be defined for a face-centered quantity. The divergence of the flux of <span>$T$</span> over a cell,  <span>$\nabla \cdot (\bm{u} T)$</span>, required in the evaluation of <span>$G_T$</span>, for example, is then</p><p class="math-container">\[\renewcommand{\div}[1] {\nabla \cdot \left ( #1 \right )}
\div{\bm{u} T}
= \frac{1}{V} \left[ \delta_x^{caa} (A_x u \overline{T}^{faa})
                   + \delta_y^{aca} (A_y v \overline{T}^{afa})
                   + \delta_z^{aac} (A_z w \overline{T}^{aaf}) \right]\]</p><p>where <span>$T$</span> is interpolated onto the cell faces where it can be multiplied by the velocities, which are then differenced and  projected onto the cell centers where they added together and then added to <span>$G_T$</span> which also lives at the cell centers.</p><h2 id="Momentum-advection"><a class="docs-heading-anchor" href="#Momentum-advection">Momentum advection</a><a id="Momentum-advection-1"></a><a class="docs-heading-anchor-permalink" href="#Momentum-advection" title="Permalink"></a></h2><p>The advection terms that make up the <span>$\mathbf{G}$</span> terms in equations \eqref{eq:horizontalMomentum} and \eqref{eq:verticalMomentum} can be mathematically written as, e.g,</p><p class="math-container">\[\renewcommand{\div}[1] {\nabla \cdot \left ( #1 \right )}
\bm{u} \cdot \nabla u
    = \div{u\bm{u}} - u(\underbrace{\nabla\cdot\bm{u}}_{=0})
    = \div{u\bm{u}}\]</p><p>which can then be discretized similarly to the flux divergence operator, however, they must be discretized differently for each direction.</p><p>For example, the <span>$x$</span>-momentum advection operator is discretized as</p><p class="math-container">\[\bm{u} \cdot \nabla u
= \frac{1}{\overline{V}^x} \left[
    \delta_x^{faa} \left( \overline{A_x u}^{caa} \overline{u}^{caa} \right)
  + \delta_y^{afa} \left( \overline{A_y v}^{aca} \overline{u}^{aca} \right)
  + \delta_z^{aaf} \left( \overline{A_z w}^{aac} \overline{u}^{aac} \right)
\right]\]</p><p>where <span>$\overline{V}^x$</span> is the average of the volumes of the cells on either side of the face in question. Calculating <span>$\partial(uu)/\partial x$</span> can be performed by interpolating <span>$A_x u$</span> and <span>$u$</span> onto the cell centers then multiplying them and differencing them back onto the faces. However, in the case of the the two other terms, <span>$\partial(vu)/\partial y$</span> and <span>$\partial(wu)/\partial z$</span>, the two variables must be interpolated onto the cell edges to be multiplied then differenced back onto the cell faces.</p><h2 id="Discretization-of-isotropic-diffusion-operators"><a class="docs-heading-anchor" href="#Discretization-of-isotropic-diffusion-operators">Discretization of isotropic diffusion operators</a><a id="Discretization-of-isotropic-diffusion-operators-1"></a><a class="docs-heading-anchor-permalink" href="#Discretization-of-isotropic-diffusion-operators" title="Permalink"></a></h2><p>An isotropic viscosity operator acting on vertical momentum is discretized via</p><p class="math-container">\[    \bm{\nabla} \left ( \nu_e \bm{\nabla} w \right )
    = \frac{1}{V} \left[
          \delta_x^{faa} \left( \nu_e \overline{A_x}^{caa} \delta_x^{caa} w \right)
        + \delta_y^{afa} \left( \nu_e \overline{A_y}^{aca} \delta_y^{aca} w \right)
        + \delta_z^{aaf} \left( \nu_e \overline{A_z}^{aac} \delta_z^{aac} w \right)
    \right ] \, ,\]</p><p>where <span>$\nu$</span> is the kinematic viscosity.</p><p>An isotropic diffusion operator acting on a tracer <span>$c$</span>, on the other hand, is discretized via</p><p class="math-container">\[   \bm{\nabla} \bm{\cdot} \left ( \kappa_e \bm{\nabla} c \right ) =
    = \frac{1}{V} \left[
        \delta_x^{caa} \left( \kappa_e A_x \delta_x^{faa} c \right)
      + \delta_y^{aca} \left( \kappa_e A_y \delta_y^{afa} c \right)
      + \delta_z^{aac} \left( \kappa_e A_z \delta_z^{aaf} c \right)
    \right] \, .\]</p><h2 id="Vertical-integrals"><a class="docs-heading-anchor" href="#Vertical-integrals">Vertical integrals</a><a id="Vertical-integrals-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-integrals" title="Permalink"></a></h2><p>Vertical integrals are converted into sums along each column. For example, the hydrostatic pressure anomaly is</p><p class="math-container">\[    p_{HY}^\prime = \int_{-L_z}^0 b^\prime \; dz \, ,\]</p><p>where <span>$b^\prime$</span> is the buoyancy perturbation. Converting it into a sum that we compute from the top downwards we get</p><p class="math-container">\[    p_{HY}^\prime(k) =
        \begin{cases}
            - \overline{b_{N_z}^\prime}^{aaf} \Delta z^F_{N_z},               &amp; \quad k = N_z \, , \\
            p_{HY}^\prime(k+1) - \overline{b_{k+1}^\prime}^{aaf} \Delta z^F_k, &amp; \quad 1 \le k \le N_z - 1 \, ,
        \end{cases}\]</p><p>where we converted the sum into a recursive definition for <span>$p_{HY}^\prime(k)$</span> in terms of <span>$p_{HY}^\prime(k+1)$</span> so that the integral may be computed with <span>$\mathcal{O}(N_z)$</span> operations by a single thread.</p><p>The vertical velocity <span>$w$</span> may be computed from <span>$u$</span> and <span>$v$</span> via the continuity equation</p><p class="math-container">\[    w = - \int_{-L_z}^0 \left(\frac{\partial u}{\partial x} + \frac{\partial v}{\partial y} \right) \, dz \, ,\]</p><p>to satisfy the incompressibility condition <span>$\nabla\cdot\bm{u} = 0$</span> to numerical precision. This also involves computing a vertical integral, in this case evaluated from the bottom up</p><p class="math-container">\[    w_k =
        \begin{cases}
            0, &amp; \quad k = 1 \, , \\
            w_{k-1} - \left( \partial_x^{caa} u + \partial_y^{aca} v \right) \Delta z^C_k, &amp; \quad 2 \le k \le N_z \, .
        \end{cases}\]</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../finite_volume/">« Finite volume method</a><a class="docs-footer-nextpage" href="../boundary_conditions/">Boundary conditions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 8 December 2020 12:59">Tuesday 8 December 2020</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
