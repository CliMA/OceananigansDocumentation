<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Poisson solvers Â· Oceananigans.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://clima.github.io/OceananigansDocumentation/stable/numerical_implementation/poisson_solvers/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><script src="../../../copy.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Oceananigans.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../using_gpus/">Using GPUs</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../generated/one_dimensional_diffusion/">One-dimensional diffusion</a></li><li><a class="tocitem" href="../../generated/geostrophic_adjustment/">Geostrophic adjustment</a></li><li><a class="tocitem" href="../../generated/two_dimensional_turbulence/">Two-dimensional turbulence</a></li><li><a class="tocitem" href="../../generated/internal_wave/">Internal wave</a></li><li><a class="tocitem" href="../../generated/convecting_plankton/">Convecting plankton</a></li><li><a class="tocitem" href="../../generated/ocean_wind_mixing_and_convection/">Ocean wind mixing and convection</a></li><li><a class="tocitem" href="../../generated/langmuir_turbulence/">Langmuir turbulence</a></li><li><a class="tocitem" href="../../generated/eady_turbulence/">Eady turbulence</a></li><li><a class="tocitem" href="../../generated/kelvin_helmholtz_instability/">Kelvin-Helmholtz instability</a></li><li><a class="tocitem" href="../../generated/shallow_water_Bickley_jet/">Shallow water Bickley jet</a></li><li><a class="tocitem" href="../../generated/horizontal_convection/">Horizontal convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/notation/">Coordinate system and notation</a></li><li><a class="tocitem" href="../../physics/boussinesq/">Boussinesq approximation</a></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label"><code>NonhydrostaticModel</code></span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/nonhydrostatic_model/">Nonhydrostatic model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-4" type="checkbox"/><label class="tocitem" for="menuitem-5-4"><span class="docs-label"><code>HydrostaticFreeSurfaceModel</code></span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/hydrostatic_free_surface_model/">Hydrostatic model with a free surface</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label"><code>ShallowWaterModel</code></span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/shallow_water_model/">Shallow water model</a></li></ul></li><li><a class="tocitem" href="../../physics/buoyancy_and_equations_of_state/">Buoyancy models and equations of state</a></li><li><a class="tocitem" href="../../physics/coriolis_forces/">Coriolis forces</a></li><li><a class="tocitem" href="../../physics/turbulence_closures/">Turbulence closures</a></li><li><a class="tocitem" href="../../physics/surface_gravity_waves/">Surface gravity waves and the Craik-Leibovich approximation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Numerical implementation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../finite_volume/">Finite volume method</a></li><li><a class="tocitem" href="../spatial_operators/">Spatial operators</a></li><li><a class="tocitem" href="../pressure_decomposition/">Pressure decomposition</a></li><li><a class="tocitem" href="../time_stepping/">Time stepping</a></li><li><a class="tocitem" href="../boundary_conditions/">Boundary conditions</a></li><li class="is-active"><a class="tocitem" href>Poisson solvers</a><ul class="internal"><li><a class="tocitem" href="#The-elliptic-problem-for-the-pressure"><span>The elliptic problem for the pressure</span></a></li><li><a class="tocitem" href="#Direct-method"><span>Direct method</span></a></li><li><a class="tocitem" href="#Direct-method-with-a-vertically-stretched-grid"><span>Direct method with a vertically stretched grid</span></a></li><li><a class="tocitem" href="#Cosine-transforms-on-the-GPU"><span>Cosine transforms on the GPU</span></a></li><li><a class="tocitem" href="#Iterative-Solvers"><span>Iterative Solvers</span></a></li></ul></li><li><a class="tocitem" href="../large_eddy_simulation/">Large eddy simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Model setup</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../model_setup/overview/">Overview</a></li><li><a class="tocitem" href="../../model_setup/architecture/">Architecture</a></li><li><a class="tocitem" href="../../model_setup/number_type/">Number type</a></li><li><a class="tocitem" href="../../model_setup/grids/">Grid</a></li><li><a class="tocitem" href="../../model_setup/clock/">Clock</a></li><li><a class="tocitem" href="../../model_setup/coriolis/">Coriolis (rotation)</a></li><li><a class="tocitem" href="../../model_setup/tracers/">Tracers</a></li><li><a class="tocitem" href="../../model_setup/buoyancy_and_equation_of_state/">Buoyancy models and equation of state</a></li><li><a class="tocitem" href="../../model_setup/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../../model_setup/forcing_functions/">Forcing functions</a></li><li><a class="tocitem" href="../../model_setup/background_fields/">Background fields</a></li><li><a class="tocitem" href="../../model_setup/turbulent_diffusivity_closures_and_les_models/">Turbulent diffusivity closures and LES models</a></li><li><a class="tocitem" href="../../model_setup/lagrangian_particles/">Lagrangian particles</a></li><li><a class="tocitem" href="../../model_setup/diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../model_setup/output_writers/">Output writers</a></li><li><a class="tocitem" href="../../model_setup/checkpointing/">Checkpointing</a></li><li><a class="tocitem" href="../../model_setup/setting_initial_conditions/">Setting initial conditions</a></li></ul></li><li><a class="tocitem" href="../../simulation_tips/">Simulation tips</a></li><li><a class="tocitem" href="../../contributing/">Contributor&#39;s guide</a></li><li><a class="tocitem" href="../../gallery/">Gallery</a></li><li><a class="tocitem" href="../../references/">References</a></li><li><input class="collapse-toggle" id="menuitem-12" type="checkbox"/><label class="tocitem" for="menuitem-12"><span class="docs-label">Appendix</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../appendix/staggered_grid/">Staggered grid</a></li><li><a class="tocitem" href="../../appendix/fractional_step/">Fractional step method</a></li><li><a class="tocitem" href="../../appendix/convergence_tests/">Convergence tests</a></li><li><a class="tocitem" href="../../appendix/benchmarks/">Performance benchmarks</a></li><li><a class="tocitem" href="../../appendix/library/">Library</a></li><li><a class="tocitem" href="../../appendix/function_index/">Function index</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Numerical implementation</a></li><li class="is-active"><a href>Poisson solvers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Poisson solvers</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/Oceananigans.jl/blob/master/docs/src/numerical_implementation/poisson_solvers.md" title="Edit on GitHub"><span class="docs-icon fab">ï</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Poisson-solvers"><a class="docs-heading-anchor" href="#Poisson-solvers">Poisson solvers</a><a id="Poisson-solvers-1"></a><a class="docs-heading-anchor-permalink" href="#Poisson-solvers" title="Permalink"></a></h1><h2 id="The-elliptic-problem-for-the-pressure"><a class="docs-heading-anchor" href="#The-elliptic-problem-for-the-pressure">The elliptic problem for the pressure</a><a id="The-elliptic-problem-for-the-pressure-1"></a><a class="docs-heading-anchor-permalink" href="#The-elliptic-problem-for-the-pressure" title="Permalink"></a></h2><p>The 3D non-hydrostatic pressure field is obtained by taking the divergence of the horizontal  component of the momentum equation and invoking the vertical component to yield an elliptic  Poisson equation for the non-hydrostatic kinematic pressure</p><p class="math-container">\[   \begin{equation}
   \label{eq:poisson-pressure}
   \nabla^2 p_{NH} = \frac{\boldsymbol{\nabla} \boldsymbol{\cdot} \boldsymbol{v}^n}{\Delta t} + \boldsymbol{\nabla} \boldsymbol{\cdot} \boldsymbol{G}_{\boldsymbol{v}} \equiv \mathscr{F} \, ,
   \end{equation}\]</p><p>along with homogenous Neumann boundary conditions <span>$\boldsymbol{v} \cdot \boldsymbol{\hat{n}} = 0$</span>  (Neumann on <span>$p$</span> for wall-bounded directions and periodic otherwise) and where <span>$\mathscr{F}$</span>  denotes the source term for the Poisson equation.</p><p>For hydrostatic problems the Poisson equation above only needs to be solved for the vertically  integrated flow and the pressure field is a two dimensional term <span>$p_{S}$</span>. In this case a fully  three-dimensional solve is not needed.</p><h2 id="Direct-method"><a class="docs-heading-anchor" href="#Direct-method">Direct method</a><a id="Direct-method-1"></a><a class="docs-heading-anchor-permalink" href="#Direct-method" title="Permalink"></a></h2><p>Discretizing elliptic problems that can be solved via a classical separation-of-variables approach, such as Poisson&#39;s equation, results in a linear system of equations <span>$M \boldsymbol{x} = \boldsymbol{y}$</span> where <span>$M$</span> is a real symmetric matrix of block tridiagonal form. This allows for the matrix to be decomposed and solved efficiently, provided that the eigenvalues and eigenvectors of the blocks are known (Â§2) <a href="../../references/#Buzbee70">B. Buzbee, G. Golub, C. Nielson (1970)</a>. In the case of Poisson&#39;s equation on a rectangle, <a href="../../references/#Hockney65">R. W. Hockney (1965)</a> has taken advantage of the fact that the fast Fourier transform can be used to perform the matrix multiplication steps resulting in an even more efficient method. <a href="../../references/#Schumann88">Ulrich Schumann, Roland A Sweet (1988)</a> describe the implementation of such an algorithm for Poisson&#39;s equation on a staggered grid with Dirichlet, Neumann, and periodic boundary conditions.</p><p>The method can be explained easily by taking the Fourier transform of both sides of \eqref{eq:poisson-pressure} to yield</p><p class="math-container">\[    \begin{equation}
    \label{eq:poisson-spectral}
    -(k_x^2 + k_y^2 + k_z^2) \widehat{p}_{NH} = \widehat{\mathscr{F}}
    \quad \implies \quad
    \widehat{p}_{NH} = - \frac{\widehat{\mathscr{F}}}{k_x^2 + k_y^2 + k_z^2} \, ,
    \end{equation}\]</p><p>where <span>$\widehat{\cdot}$</span> denotes the Fourier component. Here <span>$k_x$</span>, <span>$k_y$</span>, and <span>$k_z$</span> are the wavenumbers. However, when solving the equation on a staggered grid we require a solution for <span>$p_{NH}$</span> that is second-order accurate such that when when its Laplacian is computed, <span>$\nabla^2 p_{NH}$</span> matches <span>$\mathscr{F}$</span> to machine precision. This is crucial to ensure that the projection step in Â§\ref{sec:fractional-step} works. To do this, the wavenumbers are replaced by eigenvalues <span>$\lambda_x$</span>, <span>$\lambda_y$</span>, and <span>$\lambda_z$</span> satisfying the discrete form of Poisson&#39;s equation with appropriate boundary conditions. Thus, Poisson&#39;s equation is diagonalized in Fourier space and the Fourier coefficients of the solution are easily solved for</p><p class="math-container">\[\widehat{p}_{NH}(i, j, k) = - \frac{\widehat{\mathscr{F}}(i, j, k)}{\lambda^x_i + \lambda^y_j + \lambda^z_k} \, .\]</p><p>The eigenvalues are given by <a href="../../references/#Schumann88">Ulrich Schumann, Roland A Sweet (1988)</a> and can also be tediously derived by plugging in the definition of the discrete Fourier transform into \eqref{eq:poisson-spectral}:</p><p class="math-container">\[\begin{align}
    \lambda^x_i &amp;= 4\frac{N_x^2}{L_x^2} \sin^2 \left [ \frac{(i-1)\pi}{N_x}  \right ], \quad i=0,1, \dots,N_x-1 \, , \\
    \lambda^x_j &amp;= 4\frac{N_y^2}{L_y^2} \sin^2 \left [ \frac{(j-1)\pi}{N_y}  \right ], \quad j=0,1, \dots,N_y-1 \, , \\
    \lambda^x_k &amp;= 4\frac{N_z^2}{L_z^2} \sin^2 \left [ \frac{(k-1)\pi}{2N_z} \right ], \quad k=0,1, \dots,N_z-1 \, ,
\end{align}\]</p><p>where <span>$\lambda_x$</span> and <span>$\lambda_y$</span> correspond to periodic boundary conditions in the horizontal and <span>$\lambda_z$</span> to Neumann boundary conditions in the vertical.</p><p>There is also an ambiguity in the solution to Poisson&#39;s equation as it&#39;s only defined up to a constant. To resolve this we choose the solution with zero mean by setting the zeroth Fourier coefficient <span>$p_{000}$</span> (corresponding to <span>$k_x = k_y = k_z = 0$</span>) to zero. This also has the added benefit of discarding the zero eigenvalue so we don&#39;t divide by it.</p><p>The Fast Fourier transforms are computed using FFTW.jl [<a href="../../references/#Frigo98">M. Frigo, S.G. Johnson (1998)</a> and <a href="../../references/#Frigo05">M. Frigo, S.G. Johnson (2005)</a>] on the CPU and using the cuFFT library on the GPU. Along wall-bouded dimensions, the cosine transform is used. In particular, as the transforms are performed on a staggered grid, DCT-II (<code>REDFT10</code>) is used to perform the forward cosine transform and DCT-III (<code>REDFT01</code>) is used to perform the inverse cosine transform.</p><h2 id="Direct-method-with-a-vertically-stretched-grid"><a class="docs-heading-anchor" href="#Direct-method-with-a-vertically-stretched-grid">Direct method with a vertically stretched grid</a><a id="Direct-method-with-a-vertically-stretched-grid-1"></a><a class="docs-heading-anchor-permalink" href="#Direct-method-with-a-vertically-stretched-grid" title="Permalink"></a></h2><p>Using Fourier transforms for all three dimensions results in a method requiring <span>$\mathcal{O}(N \log_2 N)$</span> operations where <span>$N$</span> is the total number of grid points. This algorithm can be made even more efficient by solving a tridiagonal system along one of the dimensions and utilizing cyclic reduction. This results in the <em>Fourier analysis cyclic reduction</em> or <span>$\text{FACR}(\ell)$</span> algorithm (with <span>$\ell$</span> cyclic reduction steps) which requires only <span>$\mathcal{O}(N \log_2\log_2 N)$</span> operations provided the optimal number of cyclic reduction steps is taken, which is <span>$\ell = \log_2 \log_2 n$</span> where <span>$n$</span> is the number of grid points in the cyclic reduction dimension. The FACR algorithm was first developed by <a href="../../references/#Hockney69">R. W. Hockney (1969)</a> and is well reviewed by <a href="../../references/#Swarztrauber77">Paul N. Swarztrauber (1977)</a> then further benchmarked and extended by <a href="../../references/#Temperton79">Clive Temperton (1979)</a> and <a href="../../references/#Temperton80">Clive Temperton (1980)</a>.</p><p>Furthermore, the FACR algorithm removes the restriction that the grid is uniform in one of the dimensions so it can be utilized to implement a fast Poisson solver for vertically stretched grids if the cyclic reduction is applied in the along the vertical dimension.</p><p>Expanding <span>$p_{NH}$</span> and <span>$\mathscr{F}$</span> into Fourier modes along the <span>$x$</span> and <span>$y$</span> directions</p><p class="math-container">\[p_{ijk} = \sum_{m=1}^{N_x} \sum_{n=1}^{N_y} \tilde{p}_{mnk} \; e^{-\mathrm{i} 2\pi i m / N_x} \;  e^{-\mathrm{i} 2\pi j n / N_y} \, ,\]</p><p>and recalling that Fourier transforms do <span>$\partial_x \rightarrow \mathrm{i} k_x$</span> and <span>$\partial_y \rightarrow \mathrm{i} k_y$</span> we can write \eqref{eq:poisson-pressure} as</p><p class="math-container">\[\sum_{m=1}^{N_x} \sum_{n=1}^{N_y}
\left\lbrace
    \partial_z^2 \tilde{p}_{mnk} - (k_x^2 + k_y^2) \tilde{p}_{mnk} - \tilde{\mathscr{F}}_{mnk}
\right\rbrace e^{-\mathrm{i} 2 \pi i m / N_x}  e^{-\mathrm{i} 2 \pi j n / N_y} = 0 \, .\]</p><p>Discretizing the <span>$\partial_z^2$</span> derivative and equating the term inside the brackets to zero we arrive at <span>$N_x\times N_y$</span> symmetric tridiagonal systems of <span>$N_z$</span> linear equations for the Fourier modes:</p><p class="math-container">\[\frac{\tilde{p}_{mn,k-1}}{\Delta z^C_k}
- \left\lbrace \frac{1}{\Delta z^C_k} + \frac{1}{\Delta z^C_{k+1}} + \Delta z^F_k (k_x^2 + k_y^2) \right\rbrace
  \tilde{p}_{mnk}
+ \frac{\tilde{p}_{mn,k+1}}{\Delta z^C_{k+1}}
= \Delta z^F_k \tilde{\mathscr{F}}_{mnk} \, .\]</p><h2 id="Cosine-transforms-on-the-GPU"><a class="docs-heading-anchor" href="#Cosine-transforms-on-the-GPU">Cosine transforms on the GPU</a><a id="Cosine-transforms-on-the-GPU-1"></a><a class="docs-heading-anchor-permalink" href="#Cosine-transforms-on-the-GPU" title="Permalink"></a></h2><p>Unfortunately cuFFT does not provide cosine transforms and so we must write our own fast cosine  transforms for the GPU. We implemented the fast 1D and 2D cosine transforms described by <a href="../../references/#Makhoul80">J. Makhoul (1980)</a>  which compute it by applying the regular Fourier transform to a permuted version of the array.</p><p>In this section we will be using the DCT-II as the definition of the forward cosine transform  for a real signal of length <span>$N$</span></p><p class="math-container">\[    \begin{equation}
    \label{eq:FCT}
    \text{DCT}(X): \quad Y_k = 2 \sum_{j=0}^{N-1} \cos \left[ \frac{\pi(j + \frac{1}{2})k}{N} \right] X_j \, ,
    \end{equation}\]</p><p>and the DCT-III as the definition of the inverse cosine transform</p><p class="math-container">\[    \begin{equation}
    \label{eq:IFCT}
    \text{IDCT}(X): \quad Y_k = X_0 + 2 \sum_{j=1}^{N-1} \cos \left[ \frac{\pi j (k + \frac{1}{2})}{N} \right] X_j \, ,
    \end{equation}  \]</p><p>and will use <span>$\omega_M = e^{-2 \pi \mathrm{i} / M}$</span> to denote the <span>$M^\text{th}$</span> root of unity, sometimes called the twiddle factors in the context of FFT algorithms.</p><h3 id="D-fast-cosine-transform"><a class="docs-heading-anchor" href="#D-fast-cosine-transform">1D fast cosine transform</a><a id="D-fast-cosine-transform-1"></a><a class="docs-heading-anchor-permalink" href="#D-fast-cosine-transform" title="Permalink"></a></h3><p>To calculate \eqref{eq:FCT} using the fast Fourier transform, we first permute the input signal along the appropriate dimension by ordering the odd elements first followed by the even elements to produce a permuted signal</p><p class="math-container">\[    X^\prime_n =
    \begin{cases}
        \displaystyle X_{2N}, \quad 0 \le n \le \left[ \frac{N-1}{2} \right] \, , \\
        \displaystyle X_{2N - 2n - 1}, \quad \left[ \frac{N+1}{2} \right] \le n \le N-1 \, ,
    \end{cases}\]</p><p>where <span>$[a]$</span> indicates the integer part of <span>$a$</span>. This should produce, for example,</p><p class="math-container">\[    \begin{equation}
    \label{eq:permutation}
    (a, b, c, d, e, f, g, h) \quad \rightarrow \quad (a, c, e, g, h, f, d, b) \, ,
    \end{equation}\]</p><p>after which \eqref{eq:FCT} is computed using</p><p class="math-container">\[  Y = \text{DCT}(X) = 2 \text{Re} \left\lbrace \omega_{4N}^k \text{FFT} \lbrace X^\prime \rbrace \right\rbrace \, .\]</p><h3 id="D-fast-inverse-cosine-transform"><a class="docs-heading-anchor" href="#D-fast-inverse-cosine-transform">1D fast inverse cosine transform</a><a id="D-fast-inverse-cosine-transform-1"></a><a class="docs-heading-anchor-permalink" href="#D-fast-inverse-cosine-transform" title="Permalink"></a></h3><p>The inverse \eqref{eq:IFCT} can be computed using</p><p class="math-container">\[  Y = \text{IDCT}(X) = \text{Re} \left\lbrace \omega_{4N}^{-k} \text{IFFT} \lbrace X \rbrace \right\rbrace \, ,\]</p><p>after which the inverse permutation of \eqref{eq:permutation} must be applied.</p><h3 id="D-fast-cosine-transform-2"><a class="docs-heading-anchor" href="#D-fast-cosine-transform-2">2D fast cosine transform</a><a class="docs-heading-anchor-permalink" href="#D-fast-cosine-transform-2" title="Permalink"></a></h3><p>Unfortunately, the 1D algorithm cannot be applied dimension-wise so the 2D algorithm is more  complicated. Thankfully, the permutation \eqref{eq:permutation} can be applied dimension-wise.  The forward cosine transform for a real signal of length <span>$N_1 \times N_2$</span> is then given by</p><p class="math-container">\[Y_{k_1, k_2} = \text{DCT}(X_{n_1, n_2}) =
2 \text{Re} \left\lbrace
    \omega_{4N_1}^k \left( \omega_{4N_2}^k \tilde{X} + \omega_{4N_2}^{-k} \tilde{X}^- \right)
\right\rbrace \, ,\]</p><p>where <span>$\tilde{X} = \text{FFT}(X^\prime)$</span> and <span>$\tilde{X}^-$</span> indicates that <span>$\tilde{X}$</span> is indexed in reverse.</p><h3 id="D-fast-inverse-cosine-transform-2"><a class="docs-heading-anchor" href="#D-fast-inverse-cosine-transform-2">2D fast inverse cosine transform</a><a class="docs-heading-anchor-permalink" href="#D-fast-inverse-cosine-transform-2" title="Permalink"></a></h3><p>The inverse can be computed using</p><p class="math-container">\[Y_{k_1, k_2} = \text{IDCT}(X_{n_1, n_2}) =
\frac{1}{4} \text{Re} \left\lbrace
    \omega_{4N_1}^{-k} \omega_{4N_2}^{-k}
    \left( \tilde{X} - M_1 M_2 \tilde{X}^{--} \right)
    - \mathrm{i} \left( M_1 \tilde{X}^{-+} + M_2 \tilde{X}^{+-} \right)
\right\rbrace \, ,\]</p><p>where <span>$\tilde{X} = \text{IFFT}(X)$</span> here, <span>$\tilde{X}^{-+}$</span> is indexed in reverse along the first dimension, <span>$\tilde{X}^{-+}$</span> along the second dimension, and <span>$\tilde{X}^{--}$</span> along both. <span>$M_1$</span> and <span>$M_2$</span> are masks of lengths <span>$N_1$</span> and <span>$N_2$</span> respectively, both containing ones except at the first element where <span>$M_0 = 0$</span>. Afterwards, the inverse permutation of \eqref{eq:permutation} must be applied.</p><p>Due to the extra steps involved in calculating the cosine transform in 2D, running with two  wall-bounded dimensions typically slows the model down by a factor of 2. Switching to the FACR  algorithm may help here as a 2D cosine transform won&#39;t be necessary anymore.</p><h2 id="Iterative-Solvers"><a class="docs-heading-anchor" href="#Iterative-Solvers">Iterative Solvers</a><a id="Iterative-Solvers-1"></a><a class="docs-heading-anchor-permalink" href="#Iterative-Solvers" title="Permalink"></a></h2><p>For problems with irregular grids the eigenvectors of the discrete Poisson operator are no longer simple Fourier series sines and cosines. This means discrete Fast Fourier Transforms can&#39;t be used to generate the projection  of the equation right hand side onto eigenvectors. So an eigenvector based approach to solving the Poisson equation is not computationally efficient.</p><p>An pre-conditioned conjugate gradient iterative solver is used instead for problems with grids that are non uniform in multiple directions. This includes curvilinear grids on the sphere and also telescoping cartesian grids that stretch along more than one dimension. There are two forms  of the pressure operator in this approach. One is rigid lid form and one is an implicit  free-surface form.</p><h3 id="Rigid-lid-pressure-operator"><a class="docs-heading-anchor" href="#Rigid-lid-pressure-operator">Rigid lid pressure operator</a><a id="Rigid-lid-pressure-operator-1"></a><a class="docs-heading-anchor-permalink" href="#Rigid-lid-pressure-operator" title="Permalink"></a></h3><p>The rigid lid operator is based on the same continuous form as is used in the Direct Method solver.</p><h3 id="Implicit-free-surface-pressure-operator"><a class="docs-heading-anchor" href="#Implicit-free-surface-pressure-operator">Implicit free surface pressure operator</a><a id="Implicit-free-surface-pressure-operator-1"></a><a class="docs-heading-anchor-permalink" href="#Implicit-free-surface-pressure-operator" title="Permalink"></a></h3><p>The implicit free surface solver solves for the free-surface, <span>$\eta$</span>, in the vertically integrated continuity equation</p><p class="math-container">\[    \begin{equation}
    \label{eq:vertically-integrated-continuity}
    \partial_t \eta + \partial_x (H \hat{u}) + \partial_y (H \hat{v}) = M \, ,
    \end{equation}\]</p><p>where <span>$M$</span> is some surface volume flux (e.g., terms such as precipitation, evaporation and runoff);  currently <span>$M=0$</span> is assumed. To form a linear system that can be solved implicitly we recast the continuity equation into a discrete integral form</p><p class="math-container">\[    \begin{equation}
    \label{eq:semi-discrete-integral-continuity}
    A_z \partial_t \eta + \delta_{x}^{caa} \sum_{k} A_{x} u + \delta_y^{caa} \sum_k A_y v = A_z M \, ,
    \end{equation}\]</p><p>and apply the discrete form to the hydrostatic form of the velocity fractional step equation</p><p class="math-container">\[    \begin{equation}
    \label{eq:hydrostatic-fractional-step}
    \boldsymbol{v}^{n+1} = \boldsymbol{v}^{\star} - g \Delta t \boldsymbol{\nabla} \eta^{n+1} \, .
    \end{equation}\]</p><p>as follows.</p><p>Assuming <span>$M=0$</span> (for now), for the <span>$n+1$</span> timestep velocity we want the following to hold</p><p class="math-container">\[    A_z \frac{\eta^{n+1} - \eta^{n}}{\Delta t} = -\delta_x^{caa} \sum_k A_x u^{n+1} - \delta_y^{caa} \sum_k A_y v^{n+1} \, .\]</p><p>Substituting <span>$u^{n+1}$</span> and <span>$v^{n+1}$</span> from the discrete form of the  right-hand-side of \eqref{eq:hydrostatic-fractional-step} then gives an implicit equation for <span>$\eta^{n+1}$</span>,</p><p class="math-container">\[\begin{align}
   \delta_x^{caa}\sum_k A_x \partial_x^{faa} \eta^{n+1} &amp; + \delta_y^{aca} \sum_k A_y \partial_y^{afa} \eta^{n+1} - \frac{1}{g \, \Delta t^2} A_z \eta^{n+1} = \nonumber \\
   &amp; = \frac{1}{g \, \Delta t} \left( \delta_x^{caa} \sum_k A_x u^{\star} + \delta_y^{aca} \sum_k A_y v^{\star} \right ) - \frac{1}{g \, \Delta t^{2}} A_z \eta^{n} \, .
\end{align}\]</p><p>Formulated in this way, the linear operator will be symmetric and so can be solved using a preconditioned conjugate gradient algorithmn.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../boundary_conditions/">Â« Boundary conditions</a><a class="docs-footer-nextpage" href="../large_eddy_simulation/">Large eddy simulation Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.12 on <span class="colophon-date" title="Wednesday 26 January 2022 06:11">Wednesday 26 January 2022</span>. Using Julia version 1.6.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
