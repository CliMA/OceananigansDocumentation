<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Numerical algorithm · Oceananigans.jl</title><link rel="canonical" href="https://ali-ramadhan.github.io/Oceananigans.jl/latest/algorithm/index.html"/><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/documenter.css" rel="stylesheet" type="text/css"/><link href="../assets/invenia.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>Oceananigans.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../">Home</a></li><li><a class="toctext" href="../examples/">Examples</a></li><li class="current"><a class="toctext" href>Numerical algorithm</a><ul class="internal"><li><a class="toctext" href="#Grids-and-variables-1">Grids and variables</a></li><li><a class="toctext" href="#Governing-prognostic-equations-and-boundary-conditions-1">Governing prognostic equations and boundary conditions</a></li><li><a class="toctext" href="#Numerical-strategy-1">Numerical strategy</a></li><li><a class="toctext" href="#Discrete-operators-1">Discrete operators</a></li><li><a class="toctext" href="#Time-stepping-1">Time stepping</a></li><li><a class="toctext" href="#The-elliptic-problem-for-the-pressure-1">The elliptic problem for the pressure</a></li></ul></li><li><span class="toctext">Internals</span><ul><li><a class="toctext" href="../internal/grids/">Grids</a></li><li><a class="toctext" href="../internal/fields/">Fields</a></li><li><a class="toctext" href="../internal/operators/">Operators</a></li></ul></li><li><a class="toctext" href="../subject_index/">Index</a></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Numerical algorithm</a></li></ul><a class="edit-page" href="https://github.com/ali-ramadhan/Oceananigans.jl/blob/master/docs/src/algorithm.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Numerical algorithm</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Numerical-algorithm-1" href="#Numerical-algorithm-1">Numerical algorithm</a></h1><p>Here we present notes on the governing equations, spatial discretization schemes, time-stepping algorithms, and elliptic equation solvers for Oceananigans.jl. Both hydrostatic (HY) and non-hydrostatic (NHY) algorithms are presented, although the model can only be run in non-hydrostatic mode right now.</p><h2><a class="nav-anchor" id="Grids-and-variables-1" href="#Grids-and-variables-1">Grids and variables</a></h2><p>Lay out a Cartesian array <span>$(x,y,z)$</span> of cubes of horizontal dimensions <span>$\Delta x, \Delta y$</span> and vertical dimension <span>$\Delta z$</span> as in the figure below. Define the areas of the cell faces as <span>$A_x = \Delta y \Delta z$</span>, <span>$A_y = \Delta x \Delta z$</span>, and <span>$A_z = \Delta x \Delta y$</span>. Each cell encloses a volume <span>$V = \Delta x \Delta y \Delta z$</span>. Velocities <span>$(u,v,w) = (v_x, v_y, v_z)$</span> are normal to the requisite face, that is, they are defined on the faces of the cells.</p><p><img src="../assets/single_volume.png" alt="Schematic of a single volume"/>  </p><p>Tracer variables, which are cell averages, are temperature <span>$T$</span> and salinity <span>$S$</span> and thus are stored at the cell centers. Pressure <span>$p$</span> and density <span>$\rho$</span> are also defined at the cell centers. The faces of the cells are coincident with three orthogonal coordinate axes (Cartesian in this case). Vorticity <span>$\mathbf{\omega}=\nabla\times\mathbf{u}$</span> and certain intermediate quantities are stored at the cell edges. (In 2D it would more correct to say the cell corners, however, in 3D variables like vorticity <span>$\mathbf{\omega}$</span> lie at the same vertical levels as the cell-centered variables and so they really lie at the cell edges. In addition to being technically correct, we abbreviate cell centers as <span>$c$</span> and cell faces as <span>$f$</span> in subscripts, so edges can use <span>$e$</span> while corners would conflict with cell centers.)</p><p>The cells are indexed by <span>$(i,j,k)$</span> where <span>$i\in \{1,2,\dots,N_x\}$</span>, <span>$j\in \{1,2,\dots,N_y\}$</span>, and <span>$k\in \{1,2,\dots,N_z\}$</span> with <span>$k=1$</span> corresponding to the top and <span>$k=N_z$</span> corresponding to the bottom. (To solve the equations on the sphere, the &quot;quads&quot; used to grid the sphere are appropriately defined including geometrical information and the <span>$G$</span>&#39;s in the equations have to be modified slightly to include metric terms. But the underlying algorithm remains the same.)</p><p>While there are <span>$N$</span> cells and cells centers per dimension and <span>$N+1$</span> cell faces and cell edges per dimension, all fields are stored as <span>$N_x \times N_y \times N_z$</span> fields. The reason for this is that for the case of periodic boundary conditions, the values at face <span>$N+1$</span> equal the values at face <span>$1$</span> so there is no need to store an extra face, and for walled boundaries, faces <span>$N+1$</span> and <span>$1$</span> both represent walls so again there is no need to store an extra face. This will change for the case of open boundary conditions which are not considered here.</p><h2><a class="nav-anchor" id="Governing-prognostic-equations-and-boundary-conditions-1" href="#Governing-prognostic-equations-and-boundary-conditions-1">Governing prognostic equations and boundary conditions</a></h2><p>The governing equations are the rotating, incompressible, Boussinesq equations of motion. They are an approximation to the full Navier-Stokes equations in a non-intertial reference frame that is appropriate for the ocean and may be written as:</p><div>\[\newcommand\p[2]{\frac{\partial #1}{\partial #2}}
\begin{equation}
  \p{\mathbf{v}_h}{t} = \mathbf{G}_{vh} - \nabla_h p
  \label{eqn:horizontalMomentum}
\end{equation}\]</div><div>\[\begin{equation}
  \p{w}{t} = G_w - \p{p}{z}
  \label{eqn:verticalMomentum}
\end{equation}\]</div><div>\[\begin{equation}
  \nabla \cdot \mathbf{v} = 0
  \label{eqn:continuity}
\end{equation}\]</div><div>\[\begin{equation}
  \p{T}{t} = G_T
  \label{eqn:TTendency}
\end{equation}\]</div><div>\[\begin{equation}
  \p{S}{t} = G_S
  \label{eqn:STendency}
\end{equation}\]</div><div>\[\begin{equation}
  \rho = \rho(T,S,p)
  \label{eqn:EOS}
\end{equation}\]</div><p>where <span>$\mathbf{v} = (\mathbf{v}_h, w) = (u,v,w)$</span> is the velocity, <span>$\mathbf{v}_h = (u,v)$</span> is the horizontal velocity, <span>$\nabla = (\partial_x, \partial_y, \partial_z)$</span> is the del operator, and <span>$\nabla_h = (\partial_x, \partial_y)$</span> is the horizontal del operator. Equations \eqref{eqn:horizontalMomentum} and \eqref{eqn:verticalMomentum} are the horizontal and vertical momentum equations respectively. Equation \eqref{eqn:continuity} is the continuity equation expressing conservation of mass. Equations \eqref{eqn:TTendency} and \eqref{eqn:STendency} prognostic equations describing the time evolution of temperature <span>$T$</span> and salinity <span>$S$</span>. Equation \eqref{eqn:EOS} is an equation of state for seawater giving the density <span>$\rho$</span> in terms of <span>$T$</span>, <span>$S$</span>, and <span>$p$</span>. The source terms <span>$\mathbf{G}_v = (\mathbf{G}_{vh}, G_w) = (G_u, G_v, G_w)$</span> represents inertial, Coriolis, gravitational, forcing, and dissipation terms. They can be written as</p><div>\[\begin{align}
    G_u &amp;= -\mathbf{v} \cdot \nabla u + fv - \frac{1}{\rho_0} \p{p&#39;_{HY}}{x} + \nabla\cdotp (\nu\nabla u) + F_u \\
    G_v &amp;= -\mathbf{v} \cdot \nabla v - fu - \frac{1}{\rho_0} \p{p&#39;_{HY}}{y} + \nabla\cdotp (\nu\nabla v) + F_v \\
    G_w &amp;= -\mathbf{v} \cdot \nabla w - \nabla\cdotp (\nu\nabla w) + F_w
\end{align}\]</div><p>where <span>$f = 2\Omega\sin\phi$</span> is the Coriolis frequency, <span>$\Omega$</span> is the rotation rate of the Earth, <span>$\phi$</span> is the latitude, <span>$g$</span> is the acceleration due to gravity, <span>$p&#39;_{HY}$</span> is the hydrostatic pressure anomaly, <span>$\rho_0$</span> is a reference density corresponding to an ocean at rest, and <span>$\nu$</span> is the viscosity. <span>$F_u$</span>, <span>$F_v$</span>, and <span>$F_w$</span> represent other forcing terms that may be imposed. Note that the buoyancy term <span>$-g(\delta\rho/\rho_0)$</span> that is usually present in the vertical momentum equation has been expressed in terms of the hydrostatic pressure anomaly <span>$p&#39;_{HY}$</span> which ends up in the horizontal momentum equations. (This step will be shown in an appendix.)</p><p>Similarly, the source terms for the tracer quantities can be written as</p><div>\[\begin{equation}
  G_T = -\nabla \cdot (\mathbf{v} T) + \kappa\nabla^2 T + F_T
  \label{eqn:G_T}
\end{equation}\]</div><div>\[\begin{equation}
  G_S = -\nabla \cdot (\mathbf{v} S) + \kappa\nabla^2 S + F_S
  \label{eqn:G_S}
\end{equation}\]</div><p>where <span>$\kappa$</span> is the diffusivity while <span>$F_T$</span> and <span>$F_S$</span> represent forcing terms.</p><p>The associated boundary conditions for the embedded non-hydrostatic models is periodic in the horizontal direction and a rigid boundary or &quot;lid&quot; at the top and bottom. The rigid lid approximation sets <span>$w = 0$</span> at the vertical boundaries so that it does not move but still allows a pressure to be exerted on the fluid by the lid.</p><h2><a class="nav-anchor" id="Numerical-strategy-1" href="#Numerical-strategy-1">Numerical strategy</a></h2><p>To numerically solve the governing equations, they must be appropriately discretized. To this effect a number of strategies are employed to ensure the discretized equations satisfy the same conservative properties that the incompressible Navier-Stokes equations satisfy, and to ensure that the numerical solution is stable.</p><p>The main strategies involve the use of a staggered grid and the splitting of the pressure field into three components.</p><h3><a class="nav-anchor" id="Staggered-grid-1" href="#Staggered-grid-1">Staggered grid</a></h3><p>As shown in the schematic of a single volume and discussed earlier the velocities are defined as averages over faces while other quantities are cell averages stored at the cell centers. This staggered storage of variables is more complicated than the collocated grid arrangement but is massively beneficial as it avoids the odd-even decoupling between the pressure and velocity if they are stored at the same positions. Odd-even decoupling is a discretization error that can occur on collocated grids and which leads to checkerboard patterns in the solutions (See the CFD Online article on <a href="https://www.cfd-online.com/Wiki/Staggered_grid">staggered grids</a>). Another way to look at this is that the discrete Poisson equation used to enforce incompressibility has a null space. The null space often manifests itself in producing solutions with checkerboard pressure fields. The staggering of variables effectively eliminates the null space; however, when it is used in the context of curvilinear coordinates its consistent implementation is complicated because it requires the use of contravariant velocity components and variable coordinate base vectors [See A. S. Dvinsky &amp; J. K. Dukowicz, <a href="https://www-sciencedirect-com.libproxy.mit.edu/science/article/pii/0045793093900336">Null-space-free methods for the incompressible Navier-Stokes equations on non-staggered curvilinear grids</a>, <em>Computers &amp; Fluids</em> <strong>22</strong>(6), pp. 685–696 (1993)].</p><h3><a class="nav-anchor" id="Splitting-of-the-pressure-field-1" href="#Splitting-of-the-pressure-field-1">Splitting of the pressure field</a></h3><p>Another strategy employed is to split the pressure field into three components</p><div>\[\begin{equation} \label{eqn:pressure_split}
    p(x,y,z) = p_S(x,y) + p_{HY}(x,y,z) + qp_{NH}(x,y,z)
\end{equation}\]</div><p>where the first term, <span>$p_S$</span>, is the surface pressure–-the pressure exerted by the fluid under the rigid lid at the surface; it is only a function of horizontal position and is found by inverting a 2D elliptic Poisson equation. The second term is the hydrostatic pressure <span>$p_{HY}$</span> defined in terms of the weight of water in a vertical column above the depth <span>$z$</span></p><div>\[\begin{equation} \label{eqn:hydrostaticPressure}
    \p{p_{HY}}{z} + g&#39; = 0
\end{equation}\]</div><p>where <span>$g&#39; = g(\delta \rho / \rho_0)$</span> is the <em>reduced gravity</em>. The third term is the non-hydrostatic pressure <span>$p_{NH}$</span> which must be found by inverting a 3D elliptic equation analogous to \eqref{eqn:ellipticPressure}. Note that the parameter <span>$q$</span> in, for example, \eqref{eqn:pressure_split}, is a trace parameter that is set to zero in HY and to one in the NHY algorithm. The methods we use to solve for the various components of the pressure field will be described in the next section.</p><p>A related quantity, the geopotential <span>$\phi = p / \rho_0$</span> is used as required.</p><h2><a class="nav-anchor" id="Discrete-operators-1" href="#Discrete-operators-1">Discrete operators</a></h2><p>To calculate the various terms and perform the time-stepping, discrete difference and interpolation operators must be designed from which all the terms, such as momentum advection and Laplacian diffusion, may be constructed. These operators introduced in this section are for a Cartesian grid with periodic boundary conditions in the horizontal and a rigid lid at the top and bottom. The operators will change form for other grids such as the cubed sphere.</p><h3><a class="nav-anchor" id="Difference-operators-1" href="#Difference-operators-1">Difference operators</a></h3><p>Difference operators act as the discrete form of the derivative operators. Care must be taken when calculating differences as the difference of a cell-centered variable such as temperature <span>$T$</span> lies on the faces in the direction of the difference, and vice versa. In principle, there are three difference operators, one for each direction</p><div>\[\begin{equation}
  \delta_x f = f_E - f_W
  \label{eqn:delta_x}
\end{equation}\]</div><div>\[\begin{equation}
  \delta_y f = f_N - f_S
  \label{eqn:delta_y}
\end{equation}\]</div><div>\[\begin{equation}
  \delta_z f = f_T - f_B
  \label{eqn:delta_z}
\end{equation}\]</div><p>where the <span>$E$</span> and <span>$W$</span> subscripts indicate that the value is evaluated the eastern or western wall of the cell, <span>$N$</span> and <span>$S$</span> indicate the northern and southern walls, and <span>$T$</span> and <span>$B$</span> indicate the top and bottom walls.</p><p>Additionally, three <span>$\delta$</span> operators must be defined for each direction to account for the staggered nature of the grid. One for taking the difference of a cell-centered variable and projecting it onto the cell faces</p><div>\[\begin{align}
    \delta_x^{c \rightarrow f} f_{i,j,k} &amp;= f_{i,j,k} - f_{i-1,j,k} \\
    \delta_y^{c \rightarrow f} f_{i,j,k} &amp;= f_{i,j,k} - f_{i,j-1,k} \\
    \delta_z^{c \rightarrow f} f_{i,j,k} &amp;= f_{i,j,k} - f_{i,j,k-1}
\end{align}\]</div><p>and another for taking the difference of a face-centered variable and projecting it onto the cell centers</p><div>\[\begin{align}
    \delta_x^{f \rightarrow c} f_{i,j,k} &amp;= f_{i+1,j,k} - f_{i,j,k} \\
    \delta_y^{f \rightarrow c} f_{i,j,k} &amp;= f_{i,j+1,k} - f_{i,j,k} \\
    \delta_z^{f \rightarrow c} f_{i,j,k} &amp;= f_{i,j,k+1} - f_{i,j,k}
\end{align}\]</div><p>The third <span>$\delta$</span> operator of use is the one that takes the difference of an edge-centered variable and projects it onto the cell faces, <span>$\delta^{e \rightarrow f}$</span>, which looks the same as <span>$\delta^{f \rightarrow c}$</span>. While it is computationally redundant, it is included for clarity.</p><p>The horizontal difference operators, <span>$\delta_x$</span> and <span>$\delta_y$</span>, take into account the periodic boundary conditions while the vertical difference operator <span>$\delta_z$</span> must take into account the rigid lid. In the vertical this is done by imposing that <span>$\delta_z^{c \rightarrow f}f_{i,j,1} = f_{i,j,1}$</span> and <span>$\delta_z^{f \rightarrow c}f_{i,j,N_z} = f_{i,j,N_z}$</span>.</p><h3><a class="nav-anchor" id="Interpolation-operators-1" href="#Interpolation-operators-1">Interpolation operators</a></h3><p>In order to add or multiply variables that are defined at different points they are interpolated. In our case, linear interpolation or averaging is employed. Once again, there are three averaging operators, one for each direction,</p><div>\[\begin{equation}
  \overline{f}^x = \frac{f_E + f_W}{2}
  \label{eqn:avg_x}
\end{equation}\]</div><div>\[\begin{equation}
  \overline{f}^y = \frac{f_N + f_S}{2}
  \label{eqn:avg_y}
\end{equation}\]</div><div>\[\begin{equation}
  \overline{f}^z = \frac{f_T + f_B}{2}
  \label{eqn:avg_z}
\end{equation}\]</div><p>Additionally, three averaging operators must be defined for each direction. One for taking the average of a cell-centered variable and projecting it onto the cell faces</p><div>\[\begin{align}
    \overline{f_{i,j,k}}^{x,c \rightarrow f} = \frac{f_{i,j,k} + f_{i-1,j,k}}{2} \\
    \overline{f_{i,j,k}}^{y,c \rightarrow f} = \frac{f_{i,j,k} + f_{i,j-1,k}}{2} \\
    \overline{f_{i,j,k}}^{z,c \rightarrow f} = \frac{f_{i,j,k} + f_{i,j,k-1}}{2}
\end{align}\]</div><p>and another for taking the average of a face-centered variable and projecting it onto the cell centers</p><div>\[\begin{align}
    \overline{f_{i,j,k}}^{x,f \rightarrow c} = \frac{f_{i+1,j,k} + f_{i,j,k}}{2} \\
    \overline{f_{i,j,k}}^{y,f \rightarrow c} = \frac{f_{i,j+1,k} + f_{i,j,k}}{2} \\
    \overline{f_{i,j,k}}^{z,f \rightarrow c} = \frac{f_{i,j,k+1} + f_{i,j,k}}{2}
\end{align}\]</div><p>The third averaging operator of use is the one that takes the difference of a face-centered variable and projects it onto the cell edges, <span>$\overline{f}^{f \rightarrow e}$</span>, which is the same as <span>$\delta^{c \rightarrow f}$</span>.</p><p>The horizontal averaging operators take into account the periodic boundary conditions while the vertical averaging operator takes in to account the presence of the rigid lid.</p><h3><a class="nav-anchor" id="Divergence-and-flux-divergence-operators-1" href="#Divergence-and-flux-divergence-operators-1">Divergence and flux divergence operators</a></h3><p>The divergence of the flux of a cell-centered quantity over the cell can be calculated as</p><div>\[\begin{equation}
    \nabla \cdot \mathbf{f} = \frac{1}{V} \left[ \delta_x^{c \rightarrow f} (A_x f_x)  + \delta_y^{c \rightarrow f} (A_y f_y) + \delta_z^{c \rightarrow f} (A_z f_z) \right]
\end{equation}\]</div><p>where <span>$\mathbf{f} = (f_x, f_y, f_z)$</span> is the flux with components defined normal to the faces, and <span>$V$</span> is the volume of the cell. The presence of a solid boundary is indicated by setting the appropriate flux normal to the boundary to zero. In our case, we have already done this in the definition of the <span>$\delta$</span> operators. A similar divergence operator can be defined for a face-centered quantity.</p><p>The divergence of the flux of <span>$T$</span> over a cell, <span>$\nabla \cdot (\mathbf{v} T)$</span>, required in the evaluation of <span>$G_T$</span>, for example, is then</p><div>\[\begin{equation}
    \nabla \cdot (\mathbf{v} T) = \frac{1}{V} \left[ \delta_x^{f \rightarrow c} (A_x u \overline{T}^x) + \delta_y^{f \rightarrow c} (A_y v \overline{T}^y) + \delta_z^{f \rightarrow c} (A_z w \overline{T}^z) \right]
\end{equation}\]</div><p>where <span>$T$</span> is interpolated onto the cell faces where it can be multiplied by the velocities, which are then differenced and projected onto the cell centers where they added together and then added to <span>$G_T$</span> which also lives at the cell centers.</p><h3><a class="nav-anchor" id="Momentum-advection-operators-1" href="#Momentum-advection-operators-1">Momentum advection operators</a></h3><p>The advection terms that make up the <span>$\mathbf{G}$</span> terms in equations \eqref{eqn:horizontalMomentum} and \eqref{eqn:verticalMomentum} can be mathematically written as</p><div>\[\begin{equation}
    \mathbf{u} \cdot \nabla v
    = \nabla \cdot (v\mathbf{u}) - v\underbrace{(\nabla\cdot\mathbf{u})}_{=0}
    = \nabla \cdot (v\mathbf{u})
\end{equation}\]</div><p>which can then be discretized similarly to the flux divergence operator, however, they must be discretized differently for each direction.</p><p>For example, the <span>$x$</span>-momentum advection operator is discretized as</p><div>\[\begin{equation}
    \mathbf{u} \cdot \nabla u
    = \frac{1}{\overline{V}^x} \left[
      \delta_x^{c \rightarrow f} \left( \overline{A_x u}^{x, f \rightarrow c} \overline{u}^{x, f \rightarrow c} \right)
      + \delta_y^{e \rightarrow f} \left( \overline{A_y v}^{x, f \rightarrow e} \overline{u}^{y, f \rightarrow e} \right)
      + \delta_z^{e \rightarrow f} \left( \overline{A_z w}^{x, f \rightarrow e} \overline{u}^{z, f \rightarrow e} \right) \right]
\end{equation}\]</div><p>where <span>$\overline{V}^x$</span> is the average of the volumes of the cells on either side of the face in question. Calculating <span>$\partial(uu)/\partial x$</span> can be performed by interpolating <span>$A_x u$</span> and <span>$u$</span> onto the cell centers then multiplying them and differencing them back onto the faces. However, in the case of the the two other terms, <span>$\partial(vu)/\partial y$</span> and <span>$\partial(wu)/\partial z$</span>, the two variables must be interpolated onto the cell edges to be multiplied then differenced back onto the cell faces.</p><h3><a class="nav-anchor" id="Laplacian-diffusion-operator-1" href="#Laplacian-diffusion-operator-1">Laplacian diffusion operator</a></h3><p>Laplacian diffusion is discretized for tracer quantities as</p><div>\[\begin{equation}
    \nabla \cdot (\kappa \nabla T)
    = \frac{1}{V} \left[
        \delta_x^{f \rightarrow c} \left( \kappa_h A_x \delta_x^{c \rightarrow f} T \right)
      + \delta_y^{f \rightarrow c} \left( \kappa_h A_y \delta_y^{c \rightarrow f} T \right)
      + \delta_z^{f \rightarrow c} \left( \kappa_v A_z \delta_z^{c \rightarrow f} T \right)
    \right]
\end{equation}\]</div><p>where <span>$\kappa$</span> is the diffusivity, usually taken to be the eddy diffusivity, and different diffusivities may be taken for the horizontal and vertical directions to account for the differences between horizontal and vertical turbulence.</p><h3><a class="nav-anchor" id="Viscous-terms-1" href="#Viscous-terms-1">Viscous terms</a></h3><p>Viscous dissipation operators are discretized similarly to the momentum advection operators and so there is a different one for each direction. For example, the vertical diffusion operator is discretized as</p><div>\[\begin{multline}
    \nabla \cdot (\nu \nabla w)
    = \frac{1}{V} \left[
        \delta_x^{e \rightarrow f} \left( \nu_h \overline{A_x}^{x,f \rightarrow e} \delta_x^{f \rightarrow e} u \right)
        \delta_y^{e \rightarrow f} \left( \nu_h \overline{A_y}^{y,f \rightarrow e} \delta_y^{f \rightarrow e} v \right) \nonumber \\
        \delta_z^{c \rightarrow f} \left( \nu_v \overline{A_z}^{z,f \rightarrow c} \delta_z^{f \rightarrow c} w \right)
    \right]
\end{multline}\]</div><p>where <span>$\nu$</span> is the eddy viscosity.</p><p>[Need notes on boundary conditions.]</p><h2><a class="nav-anchor" id="Time-stepping-1" href="#Time-stepping-1">Time stepping</a></h2><p>Once the source terms are calculated, the time stepping is performed as follows where superscripts indicate the time-step:</p><div>\[\begin{equation}
  \frac{\mathbf{u}^{n+1} - \mathbf{u}^n}{\Delta t} = \mathbf{G}_{\mathbf{u}}^{n+1/2} - \nabla (\phi_S + \phi_{HY} + q\phi_{NH})^{n+1/2}
  \label{eqn:velocity_time_stepping}
\end{equation}\]</div><div>\[\begin{equation}
    \frac{1}{\Delta t} \left[ \begin{pmatrix}S \\ T\end{pmatrix}^{n+1} - \begin{pmatrix}S \\ T\end{pmatrix}^n \right] = \mathbf{G}^{n+1/2}_{(S,T)}
    \label{eqn:ST_time_stepping}
\end{equation}\]</div><p>The source terms <span>$\mathbf{G}$</span> are evaluated using the Adams-Bashforth method (AB2) which makes use of time levels <span>$n$</span> and <span>$n-1$</span>:</p><div>\[\begin{equation}
    \mathbf{G}^{n+1/2} = \left( \frac{3}{2} + \chi \right) \mathbf{G}^n - \left( \frac{1}{2} + \chi \right) \mathbf{G}^{n-1}
\end{equation}\]</div><p>AB2 is a linear extrapolation in time to a point that is just, by an amount <span>$\chi$</span>, on then <span>$n+1$</span> side of the midpoint <span>$n + 1/2$</span>. AB2 has the advantage of being quasi-second-order in time and yet does not have a computational mode. Furthermore, it can be implemented by evaluating the source terms <span>$\mathbf{G}$</span> only once and storing them for use on the next time step, thus using less memory that higher-order time stepping schemes such as the popular fourth-order Runge–Kutta method. Typically we set <span>$\chi = 0.1$</span>.</p><h2><a class="nav-anchor" id="The-elliptic-problem-for-the-pressure-1" href="#The-elliptic-problem-for-the-pressure-1">The elliptic problem for the pressure</a></h2><p>The pressure field is obtained by taking the divergence of \eqref{eqn:horizontalMomentum} and invoking \eqref{eqn:verticalMomentum} to yield an elliptic Poisson equation for the geopotential field,</p><div>\[\begin{equation} \label{eqn:ellipticPressure}
    \nabla^2\phi = \nabla \cdot \mathbf{G}_{\mathbf{u}} = \mathscr{F}
\end{equation}\]</div><p>along with homogenous Neumann boundary conditions <span>$\mathbf{v} \cdot \mathbf{\hat{n}} = 0$</span> and where <span>$\mathscr{F}$</span> denotes the right-hand-side or the source term for the Poisson equation.</p><p>We solve for the pressure field in three steps. First we find the 2D surface pressure <span>$p_S(x,y)$</span>. Second we integrate vertically down from the surface to calculate the hydrostatic pressure field <span>$p_{HY}(x,y,z)$</span> according to \eqref{eqn:hydrostaticPressure}. Third, in the NHY model, we go on to solve for the 3D non-hydrostatic pressure <span>$p_{NH}(x,y,z)$</span>. The 3D pressure solve is generally the most computationally expensive operation at each time step. The HY model, however, only involves steps 1 and 2 and is so is much less computationally demanding than NHY.</p><p>We outline two methods for finding for finding the pressure field. One, the conjugate gradient method, is currently used in the MITgcm. It has the advantage of being versatile, readily supporting different boundary conditions and complicated geometries involving land boundaries. The second, a discrete Fourier-spectral method, can be used in the NHY submodels which employ a regular Cartesian grid with periodic or Neumann boundary conditions.</p><h3><a class="nav-anchor" id="Conjugate-gradient-method-1" href="#Conjugate-gradient-method-1">Conjugate-gradient method</a></h3><p>In the absence of nice boundary conditions (e.g. bathymetry and continental boundaries), a preconditioned conjugate-gradient iterative method is used to solve the 2D and 3D elliptic problems, with the solution of the 2D problem acting as the precondtioner for the 3D problem.</p><p>We now describe how to solve for the surface pressure <span>$p_S(x,y)$</span>. By setting <span>$q = 0$</span> in the momentum equations \eqref{eqn:velocity<em>time</em>stepping} and summing them over the whole depth of the ocean, invoking the continuity equation \eqref{eqn:continuity} and applying boundary conditions <span>$\mathbf{v} \cdot \mathbf{\hat{n}} = 0$</span>, the following equation for <span>$p_S$</span> results:</p><div>\[\begin{equation} \label{eqn:ellipticPS}
    \nabla_h \cdot \left( H \nabla_h \phi_S^{n+1/2} \right) = \mathscr{S}_{HY}^n - \frac{\left[ \nabla_h \left( H \overline{\mathbf{v}_h}^H \right) \right]^n}{\Delta t}
\end{equation}\]</div><p>where</p><div>\[\begin{equation} \label{eqn:S_HY}
    \mathscr{S}_{HY}^n = \nabla_h \cdot \left( H \overline{\mathbf{G}_{vh}^{n+1/2}}^H \right) - \nabla_h \cdot \left( H \overline{\nabla_h \phi_{HY}^{n+1/2}}^H \right).
\end{equation}\]</div><p>Here <span>$\bar{\cdot}^H$</span> is the discrete analogue of <span>$(1/H) \int_{-H}^0 (\cdot) dz$</span>, a vertical integral over the whole depth of the ocean. The elliptic problem \eqref{eqn:ellipticPS} and \eqref{eqn:S_HY} can be written in the concise matrix notation</p><div>\[\begin{equation}
    \mathbf{A}_\mathrm{2D} \mathbf{\phi}_S = \mathbf{f}_\mathrm{2D},
    \quad \text{where} \quad
    \mathbf{A}_\mathrm{2D} = \mathbf{D}_{\text{div}\;h} \cdot H \mathbf{G}_{\mathrm{rad}\;h}
\end{equation}\]</div><p>where <span>$\mathbf{A}_{2D}$</span> is a symmetric, positive-definite matrix (A2D has five diagonals corresponding to the coupling of the central point with surrounding points along the four <em>arms</em> of the horizontal <span>$\nabla^2$</span> Operator). composed of <span>$\mathbf{D}_{\text{div}\;h}$</span> and $ \mathbf{G}<em>{\mathrm{rad}\;h}$ (matrix representations of the <span>$div&#39;&#39; and$</span>grad&#39;&#39; operators), \mathbf{\phi}</em>S$ is a column vector of surface pressure elements, and <span>$\mathbf{f}_\mathrm{2D}$</span> is a column vector containing the elements of the right-hand side of \eqref{eqn:ellipticPressure}. The system can thus be solved using a standard conjugate-gradient method, appropriately preconditioned for efficient solution.</p><p>In nonhydrostatic calculations a three-dimensional elliptic equation must also be inverted for <span>$\phi_{NH}(x,y,z)$</span> to ensure that the local divergence vanishes. This is sometimes referred to as a pressure correction. The appropriate discrete form can be deduced in a manner that exactly parallels that which was used to deduce \eqref{eqn:ellipticPressure}. The resulting elliptic equation can be written as</p><div>\[\begin{equation}
    \mathbf{A}_\mathrm{3D} \mathbf{\phi}_{NH} = \mathbf{f}_\mathrm{3D},
    \quad \text{where} \quad
    \mathbf{A}_\mathrm{3D} = \mathbf{D}_\text{div} \cdot \mathbf{G}_\mathrm{rad}
\end{equation}\]</div><p>where <span>$\mathbf{A}_\mathrm{3D}$</span>, like <span>$\mathbf{A}_\mathrm{2D}$</span>, is a symmetric, positive-definite matrix representing the discrete representation of <span>$\nabla^2$</span>, but now in three dimensions. <span>$\mathbf{f}_\mathrm{3D}$</span> and <span>$\mathbf{\phi}_{NH}$</span> are <span>$(1 \times N)$</span> column vectors containing the source term and nonhydrostatic pressure, in each of the <span>$N = N_xN_yN_z$</span> cells into which the ocean has been carved.</p><h3><a class="nav-anchor" id="Discrete-Fourier-spectral-method-1" href="#Discrete-Fourier-spectral-method-1">Discrete Fourier-spectral method</a></h3><p>For the embedded NHY sub-models we can assume periodic boundary conditions in the horizontal and so switch to a Fourier-spectral Poisson solver which is much faster than the conjugate-gradient approach described above. In this approach, the surface and nonhydrostatic pressure can be combined so only a single elliptic problem is solved.</p><p>In this method the geopotential field <span>$\phi_{NH+S}$</span> and source term <span>$\mathscr{F}$</span> are expanded in terms of multi-dimensional Fourier series with discrete Fourier transforms (to enforce periodicity) in the horizontal and discrete cosine transforms in the vertical (to enforce the Neumann boundary conditions) and Poisson&#39;s equation is solved in the frequency domain. In Fourier space, Poisson&#39;s equation becomes</p><div>\[\begin{equation} \label{eqn:spectralPressure}
  -\mathbf{k}^2\hat{\phi}_{NH+S} = -(k_x^2 + k_y^2 + k_z^2)\hat{\phi}_{NH+S} = \hat{\mathscr{F}}
\end{equation}\]</div><p>where <span>$\hat{\phi}_{NH+S}$</span> and <span>$\hat{\mathscr{F}}$</span> are respectively the geopotential and source term in Fourier space, and the form of the wavenumbers <span>$(k_x, k_y, k_z)$</span> will depend on the boundary conditions imposed. In the case of periodic boundary conditions in the horizontal and Neumann boundary conditions in the vertical on a discrete grid they are given by</p><div>\[\begin{align}
    k_x^2(i) &amp;= 4\frac{N_x^2}{L_x^2} \sin^2 \left[ \frac{(i-1)\pi}{N_x} \right], \quad i=1,2,\dots,N_x-1 \\
    k_y^2(j) &amp;= 4\frac{N_y^2}{L_y^2} \sin^2 \left[ \frac{(j-1)\pi}{N_y} \right], \quad j=1,2,\dots,N_y-1 \\
    k_z^2(k) &amp;= 4\frac{N_z^2}{L_z^2} \sin^2 \left[ \frac{(k-1)\pi}{2N_z} \right], \quad k=1,2,\dots,N_z-1
\end{align}\]</div><p>These wavenumbers are obtained by discretizing Poisson&#39;s equation using second-order finite differences before inserting the inverse Fourier series and then diagonalizing the resulting equation in Fourier space to obtain expressions for the wavenumbers \footnote{This derivation should be detailed in an appendix.}. This specific discretization enforces that the Laplacian of the numerical solution <span>$\nabla^2\phi$</span> matches <span>$\mathscr{F}$</span> up to numerical precision and ensures that the velocity field will be divergence-free up to numerical precision, crucial for a stable time-stepping algorithm.</p><p>In the spectral method, one Fourier transforms the right hand side <span>$\hat{\mathscr{F}} = \text{DCT}_z \left( \text{FFT}_{xy} (\mathscr{F}) \right)$</span>, then calculates the pressure field in frequency space using \eqref{eqn:spectralPressure}, and then transforms the pressure back to real space to yield <span>$\phi_{NH+S} = \text{IFFT}(\hat{\phi}_{NH+S})$</span>.</p><p>Spectral methods require <span>$\mathcal{O}(N\log N)$</span> operations compared to <span>$\mathcal{O}(N^2)$</span> operations for the conjugate-gradient solver where <span>$N = N_xN_yN_z$</span>. Moreover, the spectral method returns an exact solution (in the sense that the discrete Laplacian of the solution matches the right hand side) compared to the conjugate-gradient method that can requires many iterations to converge. To fix this when using the conjugate gradient method, a further pressure correction/relaxation is computed. We believe further performance gains can be realized by using batched FFTs running on GPU accelerators.</p><footer><hr/><a class="previous" href="../examples/"><span class="direction">Previous</span><span class="title">Examples</span></a><a class="next" href="../internal/grids/"><span class="direction">Next</span><span class="title">Grids</span></a></footer></article></body></html>
